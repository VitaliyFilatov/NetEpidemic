<!DOCTYPE html>
<!-- saved from url=(0042)http://localhost:63522/Home/EpidemiModeler -->
<html class=" js flexbox flexboxlegacy canvas canvastext webgl no-touch geolocation postmessage websqldatabase indexeddb hashchange history draganddrop websockets rgba hsla multiplebgs backgroundsize borderimage borderradius boxshadow textshadow opacity cssanimations csscolumns cssgradients cssreflections csstransforms csstransforms3d csstransitions fontface generatedcontent video audio localstorage sessionstorage webworkers applicationcache svg inlinesvg smil svgclippaths"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CountMetrics – приложение ASP.NET</title>
    <link href="./CountMetrics – приложение ASP.NET_files/bootstrap.css" rel="stylesheet">
<link href="./CountMetrics – приложение ASP.NET_files/site.css" rel="stylesheet">

    <script src="./CountMetrics – приложение ASP.NET_files/modernizr-2.6.2.js.Без названия"></script>


</head>
<body style="width:100%">
    <script src="./CountMetrics – приложение ASP.NET_files/jquery-1.10.2.js.Без названия"></script>

    <script src="./CountMetrics – приложение ASP.NET_files/bootstrap.js.Без названия"></script>
<script src="./CountMetrics – приложение ASP.NET_files/respond.js.Без названия"></script>

    

    <div class="container">
        <div class="navbar navbar-inverse navbar-fixed-top mynav">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="http://localhost:63522/">Epidemic modeler</a>
                </div>
                <div class="navbar-collapse collapse">
                    <ul class="nav navbar-nav">
                        <li><a href="http://localhost:63522/">Главная страница</a></li>
                        <li><a href="http://localhost:63522/Home/About">О программе</a></li>
                        <li><a href="http://localhost:63522/Home/Contact">Контакты</a></li>
                    </ul>
                </div>
            </div>
        </div>
        </div>

        <div id="graph" class="container body-content">




            <div class="container-fluid">
                <div class="row">

                    <div id="sidebar" class="col-sm-4 col-md-2 sidebar" style="right:100%; padding-right:0; padding-left: 0;">

                        <form class="form-horizontal" role="form">
                            <div class="panel panel-default control-main">
                                <div class="row control-main">
                                    <button type="button" class="btn btn-default" data-toggle="collapse" data-target="#menuHide" style="width:100%">Меню управления</button>
                                </div>
                                <div id="menuHide" class="row control-main collapse">
                                    <ul class="nav nav-pills nav-stacked">
                                        <li><a href="http://localhost:63522/Home/EpidemiModeler#" onclick="ui.nav.click(0)">Задать</a></li>
                                        <li><a href="http://localhost:63522/Home/EpidemiModeler#" onclick="ui.nav.click(1)">Статистика и свёртка</a></li>
                                    </ul>
                                </div>
                                <div class="row control-main">
                                    <button type="button" class="btn btn-default" data-toggle="collapse" data-target="#modelHide" style="width:100%">Модель заражения</button>
                                </div>

                                <div id="modelHide" class="row control-main collapse">
                                    <ul class="nav nav-pills nav-stacked">
                                        <li><a href="http://localhost:63522/Home/EpidemiModeler#" onclick="ui.nav.click(2)">Микрофрактал</a></li>
                                        <li><a href="http://localhost:63522/Home/EpidemiModeler#" onclick="ui.nav.click(3)">Эпидемии</a></li>
                                    </ul>
                                </div>
                                <div class="row control-main">
                                    <button type="button" class="btn btn-default" data-toggle="collapse" data-target="#graphicHide" style="width:100%">Графики</button>
                                </div>

                                <div id="graphicHide" class="row control-main collapse">
                                    <ul class="nav nav-pills nav-stacked">
                                        <li><a href="http://localhost:63522/Home/EpidemiModeler#" onclick="networkGraph.selectGraphicType(0); ui.nav.click(4)">Вершин</a></li>
                                        <li><a href="http://localhost:63522/Home/EpidemiModeler#" onclick="networkGraph.selectGraphicType(1); ui.nav.click(4)">Трафика</a></li>
                                        <li><a href="http://localhost:63522/Home/EpidemiModeler#" onclick="networkGraph.selectGraphicType(2); ui.nav.click(4)">Риска</a></li>
                                        <li><a href="http://localhost:63522/Home/EpidemiModeler#" onclick="networkGraph.selectGraphicType(3); ui.nav.click(4)">Шанса</a></li>
                                    </ul>
                                </div>
                            </div>

                            <div class="panel panel-default control-additional1" style="display: block;">
                                <div class="row control-main">
                                    <button type="button" class="btn btn-default" data-toggle="collapse" data-target="#simulHide" style="width:100%">Симуляция</button>
                                </div>
                                <div id="simulHide" class="panel-body collapse">
                                    <div class="control-net" id="control-epidemic-my1" style="display: block;"><div class="progress" style="margin-bottom:5px;"><div id="epidemic_progress" class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:0%;"></div></div><div class="input-group"><input type="text" class="form-control" placeholder="" aria-describedby="basic-addon2" value="10" name="num_steps"><span class="input-group-addon" id="basic-addon2">Количество шагов</span></div><div class="btn-group" style="width:100%;"><button type="button" class="btn btn-default" onclick="networkGraph.saveNumSteps(); networkGraph.inRealTime();" style="width:25%; margin-left: 0px;"><span class="glyphicon glyphicon-play"></span></button><button type="button" class="btn btn-default" onclick="networkGraph.pauseepidemi();" style="width:25%; margin-left: 0px;"><span class="glyphicon glyphicon-pause"></span></button><button type="button" class="btn btn-default" onclick="networkGraph.stopepidemi();" style="width:25%; margin-left: 0px;"><span class="glyphicon glyphicon-stop"></span></button><button type="button" class="btn btn-default" onclick="networkGraph.clearLayeredNet(); networkGraph.clearepidemi(); ui.nav.click(3);" style="width:25%; margin-left: 0px;"><span class="glyphicon glyphicon-refresh"></span></button></div><div class="form-group"><div class="col-sm-12"><label style="font-weight: 100;"><input type="range" min="100" max="2000" step="1" value="100" name="wait_time">Задержка</label></div></div></div>
                                </div>
                            </div>

                            <div class="panel panel-default control-additional2" style="display: block;">
                                <div class="row control-main">
                                    <button type="button" class="btn btn-default" data-toggle="collapse" data-target="#paramHide" style="width:100%">Параметры</button>
                                </div>
                                <div id="paramHide" class="panel-body collapse">
                                    <div class="control-net" id="control-epidemic-my2" style="display: block;"><div class="checkbox"><label><input type="checkbox" id="layers1" onchange="networkGraph.toggleLayeredNet(); networkGraph.makeReLay(1); ui.nav.click(3);">Послойная модель</label></div><button type="button" class="btn btn-default" onclick="networkGraph.toCenter();" style="width:25%; margin-left: 0px;"><span class="glyphicon glyphicon-resize-small"></span></button></div>
                                </div>
                            </div>
                        </form>

                    </div>

                    <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main" style="padding-left: 0; padding-right: 0;">

                        <div class="panel panel-default">
                            <div class="row control-nav" id="podmenu" style="display: none;">
                            </div>
                        </div>

                        <div class="control-content">

                            <div class="panel panel-default" style="left:0px;">

                                <div class="panel-body content-elements">

                                    <div id="nav_epidemic_result" style="display: block;"><div class="row control-nav2" id="podmenu2"><ul class="nav nav-tabs"><li class="active"><a href="http://localhost:63522/Home/EpidemiModeler#" onclick="networkGraph.setTematicChanged();  networkGraph.choseMicrofractal(0); networkGraph.changeGraph(); ui.nav.click(3);">Тема1</a></li></ul></div></div>


                                    <div id="svg_container" style="display: block;">
                                    <svg height="600" width="280">
                                        <g transform="translate(279.8998556636948,182.17426172563705)scale(2.061855670103092)">
                                        <line class="link" x1="60" y1="23" x2="63" y2="3" style="stroke-width: 1;"></line>
                                        <line class="link" x1="93" y1="66" x2="63" y2="3" style="stroke-width: 1;"></line>
                                        <line class="link" x1="93" y1="66" x2="60" y2="23" style="stroke-width: 1;"></line>
                                        <line class="link" x1="20" y1="64" x2="63" y2="3" style="stroke-width: 1;"></line>
                                        <line class="link" x1="20" y1="64" x2="93" y2="66" style="stroke-width: 1;"></line>
                                        <line class="link" x1="20" y1="64" x2="60" y2="23" style="stroke-width: 1;"></line>
                                        <line class="link" x1="82" y1="106" x2="93" y2="66" style="stroke-width: 1;"></line>
                                        <line class="link" x1="82" y1="106" x2="60" y2="23" style="stroke-width: 1;"></line>
                                        <line class="link" x1="40" y1="43" x2="20" y2="64" style="stroke-width: 1;"></line>
                                        <line class="link" x1="40" y1="43" x2="60" y2="23" style="stroke-width: 1;"></line>
                                        <line class="link" x1="40" y1="43" x2="63" y2="3" style="stroke-width: 1;"></line>
                                        <line class="link" x1="11" y1="89" x2="82" y2="106" style="stroke-width: 1;"></line>
                                        <line class="link" x1="11" y1="89" x2="20" y2="64" style="stroke-width: 1;"></line>
                                        <line class="link" x1="11" y1="89" x2="40" y2="43" style="stroke-width: 1;"></line>
                                        <line class="link" x1="85" y1="21" x2="63" y2="3" style="stroke-width: 1;"></line>
                                        <line class="link" x1="85" y1="21" x2="82" y2="106" style="stroke-width: 1;"></line>
                                        <line class="link" x1="85" y1="21" x2="40" y2="43" style="stroke-width: 1;"></line>
                                        <line class="link" x1="66" y1="86" x2="60" y2="23" style="stroke-width: 1;"></line>
                                        <line class="link" x1="66" y1="86" x2="40" y2="43" style="stroke-width: 1;"></line>
                                        <line class="link" x1="66" y1="86" x2="93" y2="66" style="stroke-width: 1;"></line>
                                        <line class="link" x1="105" y1="86" x2="40" y2="43" style="stroke-width: 1;"></line>
                                        <line class="link" x1="105" y1="86" x2="82" y2="106" style="stroke-width: 1;"></line>
                                        <line class="link" x1="105" y1="86" x2="66" y2="86" style="stroke-width: 1;"></line>
                                        <line class="link" x1="40" y1="110" x2="60" y2="23" style="stroke-width: 1;"></line>
                                        <line class="link" x1="40" y1="110" x2="82" y2="106" style="stroke-width: 1;"></line>
                                        <line class="link" x1="18" y1="-1" x2="40" y2="43" style="stroke-width: 1;"></line>
                                        <line class="link" x1="18" y1="-1" x2="60" y2="23" style="stroke-width: 1;"></line>
                                        <line class="link" x1="113" y1="24" x2="60" y2="23" style="stroke-width: 1;"></line>
                                        <line class="link" x1="113" y1="24" x2="93" y2="66" style="stroke-width: 1;"></line>
                                        <line class="link" x1="113" y1="24" x2="105" y2="86" style="stroke-width: 1;"></line>
                                        <line class="link" x1="0" y1="44" x2="20" y2="64" style="stroke-width: 1;"></line><line class="link" x1="0" y1="44" x2="40" y2="43" style="stroke-width: 1;"></line><line class="link" x1="0" y1="44" x2="60" y2="23" style="stroke-width: 1;"></line><line class="link" x1="120" y1="112" x2="82" y2="106" style="stroke-width: 1;"></line><line class="link" x1="120" y1="112" x2="105" y2="86" style="stroke-width: 1;"></line><line class="link" x1="135" y1="88" x2="93" y2="66" style="stroke-width: 1;"></line><line class="link" x1="135" y1="88" x2="120" y2="112" style="stroke-width: 1;"></line><line class="link" x1="3" y1="18" x2="20" y2="64" style="stroke-width: 1;"></line><line class="link" x1="3" y1="18" x2="40" y2="43" style="stroke-width: 1;"></line><line class="link" x1="3" y1="18" x2="60" y2="23" style="stroke-width: 1;"></line><line class="link" x1="42" y1="-5" x2="60" y2="23" style="stroke-width: 1;"></line><line class="link" x1="42" y1="-5" x2="18" y2="-1" style="stroke-width: 1;"></line><line class="link" x1="42" y1="-5" x2="63" y2="3" style="stroke-width: 1;"></line><line class="link" x1="105" y1="1" x2="93" y2="66" style="stroke-width: 1;"></line><line class="link" x1="105" y1="1" x2="60" y2="23" style="stroke-width: 1;"></line><line class="link" x1="93" y1="126" x2="93" y2="66" style="stroke-width: 1;"></line><line class="link" x1="93" y1="126" x2="82" y2="106" style="stroke-width: 1;"></line><line class="link" x1="93" y1="126" x2="66" y2="86" style="stroke-width: 1;"></line><circle class="node" r="7" cx="60" cy="23" style="fill: grey;"><title>Номер: 0 Соседей: 13 Вес: 0.115 Слой: 13 Статус: Susceptible</title></circle><circle class="node" r="7" cx="63" cy="3" style="fill: grey;"><title>Номер: 1 Соседей: 6 Вес: 0.065 Слой: 6 Статус: Susceptible</title></circle><circle class="node" r="7" cx="93" cy="66" style="fill: grey;"><title>Номер: 2 Соседей: 9 Вес: 0.08 Слой: 9 Статус: Susceptible</title></circle><circle class="node" r="7" cx="20" cy="64" style="fill: grey;"><title>Номер: 3 Соседей: 7 Вес: 0.0625 Слой: 7 Статус: Susceptible</title></circle><circle class="node" r="7" cx="82" cy="106" style="fill: grey;"><title>Номер: 4 Соседей: 8 Вес: 0.105 Слой: 8 Статус: Susceptible</title></circle><circle class="node" r="7" cx="40" cy="43" style="fill: grey;"><title>Номер: 5 Соседей: 10 Вес: 0.1075 Слой: 10 Статус: Susceptible</title></circle><circle class="node" r="7" cx="11" cy="89" style="fill: grey;"><title>Номер: 6 Соседей: 3 Вес: 0.0525 Слой: 3 Статус: Susceptible</title></circle><circle class="node" r="7" cx="85" cy="21" style="fill: grey;"><title>Номер: 7 Соседей: 3 Вес: 0.025 Слой: 3 Статус: Susceptible</title></circle><circle class="node" r="7" cx="66" cy="86" style="fill: grey;"><title>Номер: 8 Соседей: 5 Вес: 0.0475 Слой: 5 Статус: Susceptible</title></circle><circle class="node" r="7" cx="105" cy="86" style="fill: grey;"><title>Номер: 9 Соседей: 5 Вес: 0.06 Слой: 5 Статус: Susceptible</title></circle><circle class="node" r="7" cx="40" cy="110" style="fill: grey;"><title>Номер: 10 Соседей: 2 Вес: 0.015 Слой: 2 Статус: Susceptible</title></circle><circle class="node" r="7" cx="18" cy="-1" style="fill: grey;"><title>Номер: 11 Соседей: 3 Вес: 0.0225 Слой: 3 Статус: Susceptible</title></circle><circle class="node" r="7" cx="113" cy="24" style="fill: grey;"><title>Номер: 12 Соседей: 3 Вес: 0.02 Слой: 3 Статус: Susceptible</title></circle><circle class="node" r="7" cx="0" cy="44" style="fill: grey;"><title>Номер: 13 Соседей: 3 Вес: 0.005 Слой: 3 Статус: Susceptible</title></circle><circle class="node" r="7" cx="120" cy="112" style="fill: grey;"><title>Номер: 14 Соседей: 3 Вес: 0.04 Слой: 3 Статус: Susceptible</title></circle><circle class="node" r="7" cx="135" cy="88" style="fill: grey;"><title>Номер: 15 Соседей: 2 Вес: 0.035 Слой: 2 Статус: Susceptible</title></circle><circle class="node" r="7" cx="3" cy="18" style="fill: grey;"><title>Номер: 16 Соседей: 3 Вес: 0.0425 Слой: 3 Статус: Susceptible</title></circle><circle class="node" r="7" cx="42" cy="-5" style="fill: grey;"><title>Номер: 17 Соседей: 3 Вес: 0.055 Слой: 3 Статус: Susceptible</title></circle><circle class="node" r="7" cx="105" cy="1" style="fill: grey;"><title>Номер: 18 Соседей: 2 Вес: 0.0225 Слой: 2 Статус: Susceptible</title></circle><circle class="node" r="7" cx="93" cy="126" style="fill: grey;"><title>Номер: 19 Соседей: 3 Вес: 0.0225 Слой: 3 Статус: Susceptible</title></circle><text></text><text></text><text></text><text></text><text></text><text></text><text></text><text></text><text></text><text></text><text></text><text></text><text></text><text></text><text></text><text></text><text></text><text></text><text></text><text></text><text x="57" y="26" font-family="sans-serif" font-size="8px" fill="White">S</text><text x="60" y="6" font-family="sans-serif" font-size="8px" fill="White">S</text><text x="90" y="69" font-family="sans-serif" font-size="8px" fill="White">S</text><text x="17" y="67" font-family="sans-serif" font-size="8px" fill="White">S</text><text x="79" y="109" font-family="sans-serif" font-size="8px" fill="White">S</text><text x="37" y="46" font-family="sans-serif" font-size="8px" fill="White">S</text><text x="8" y="92" font-family="sans-serif" font-size="8px" fill="White">S</text><text x="82" y="24" font-family="sans-serif" font-size="8px" fill="White">S</text><text x="63" y="89" font-family="sans-serif" font-size="8px" fill="White">S</text><text x="102" y="89" font-family="sans-serif" font-size="8px" fill="White">S</text><text x="37" y="113" font-family="sans-serif" font-size="8px" fill="White">S</text><text x="15" y="2" font-family="sans-serif" font-size="8px" fill="White">S</text><text x="110" y="27" font-family="sans-serif" font-size="8px" fill="White">S</text><text x="-3" y="47" font-family="sans-serif" font-size="8px" fill="White">S</text><text x="117" y="115" font-family="sans-serif" font-size="8px" fill="White">S</text><text x="132" y="91" font-family="sans-serif" font-size="8px" fill="White">S</text><text x="0" y="21" font-family="sans-serif" font-size="8px" fill="White">S</text><text x="39" y="-2" font-family="sans-serif" font-size="8px" fill="White">S</text><text x="102" y="4" font-family="sans-serif" font-size="8px" fill="White">S</text><text x="90" y="129" font-family="sans-serif" font-size="8px" fill="White">S</text></g><g></g></svg></div>
                                    <div class="table-responsive" id="table_statistics" style="display: none;"></div>
                                    <div id="svg_container3" style="display: none;"><svg class="axis" width="0" height="600"></svg></div>
                                    <div id="info" style="display: none;"></div>

                                    <div class="row" id="data_export" style="display: none;"></div>
                                    <div class="table-responsive" id="data_matrix" style="display: none;"></div>
                                    <div class="table-responsive" id="table_statistics" style="display: none;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <script src="./CountMetrics – приложение ASP.NET_files/jquery-1.10.2.js.Без названия"> </script>
            <script src="./CountMetrics – приложение ASP.NET_files/d3.v3.js.Без названия"> </script>
            <script src="./CountMetrics – приложение ASP.NET_files/vis.min.js.Без названия"> </script>
            <script src="./CountMetrics – приложение ASP.NET_files/graph.js.Без названия"> </script>
            <script src="./CountMetrics – приложение ASP.NET_files/jquery.timers.js" type="text/javascript"></script>
            <style>
                /* tell the SVG path to be a thin blue line without any area fill */
                path {
                    stroke: steelblue;
                    stroke-width: 3;
                    fill: none;
                }

                .axis {
                    shape-rendering: crispEdges;
                }

                .x.axis line {
                    stroke: lightgrey;
                }

                .x.axis .minor {
                    stroke-opacity: .5;
                }

                .x.axis path {
                    /*			  display: none;*/
                }

                .y.axis line, .y.axis path {
                    fill: none;
                    stroke: #000;
                }

                .x.axis path {
                    stroke: #000;
                }

                #data_matrix td.centrality {
                    background-color: red;
                }
            </style>

            <style>
                .my-left-menu {
                    margin-top: 5px;
                    padding-top: 0px;
                    padding-right: 0px;
                    border-right-width: 0px;
                    padding-left: 0px;
                }

                .control-nav, .control-content {
                    margin-top: 5px;
                }

                .control-nav2 {
                    margin-top: 5px;
                }

                .node {
                    stroke: #fff;
                    stroke-width: 0px;
                }

                .link {
                    stroke: #999;
                    stroke-opacity: .6;
                }

                .table > thead > tr > td.info,
                .table > tbody > tr > td.info,
                .table > tfoot > tr > td.info,
                .table > thead > tr > th.info,
                .table > tbody > tr > th.info,
                .table > tfoot > tr > th.info,
                .table > thead > tr.info > td,
                .table > tbody > tr.info > td,
                .table > tfoot > tr.info > td,
                .table > thead > tr.info > th,
                .table > tbody > tr.info > th,
                .table > tfoot > tr.info > th {
                    background-color: #eeeeee;
                }

                .table-responsive {
                    overflow-x: auto;
                    min-height: 0.01%;
                }

                .alert {
                    position: relative;
                    z-index: 2000;
                }

                /*панель действий слева*/
                .sidebar {
                    display: none;
                }

                .mynav {
                        width:100%;
                    }
                @media (max-width: 900px) {
                    .mynav {
                        width:360px;
                    }
                }

                @media (min-width: 0px) {
                    .sidebar {
                        position: fixed;
                        top: 51px;
                        bottom: 0;
                        left: 0;
                        z-index: 1000;
                        display: block;
                        padding: 5px;
                        overflow-x: hidden;
                        overflow-y: auto; /* Scrollable contents if viewport is shorter than content. */
                        background-color: #ffffff;
                        border-right: 1px solid #eee;
                    }
                }


                .axis path, .axis line {
                    fill: none;
                    stroke: #333;
                }

                .axis .grid-line {
                    stroke: #000;
                    stroke-opacity: 0.2;
                }

                .axis text {
                    font: 13px Verdana;
                }


                .material-switch > input[type="checkbox"] {
                    display: none;
                }

                .material-switch > label {
                    cursor: pointer;
                    height: 0px;
                    position: relative;
                    width: 40px;
                }

                    .material-switch > label::before {
                        background: rgb(0, 0, 0);
                        box-shadow: inset 0px 0px 10px rgba(0, 0, 0, 0.5);
                        border-radius: 8px;
                        content: '';
                        height: 16px;
                        margin-top: -8px;
                        position: absolute;
                        opacity: 0.3;
                        transition: all 0.4s ease-in-out;
                        width: 40px;
                    }

                    .material-switch > label::after {
                        background: rgb(255, 255, 255);
                        border-radius: 16px;
                        box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.3);
                        content: '';
                        height: 24px;
                        left: -4px;
                        margin-top: -8px;
                        position: absolute;
                        top: -4px;
                        transition: all 0.3s ease-in-out;
                        width: 24px;
                    }

                .material-switch > input[type="checkbox"]:checked + label::before {
                    background: inherit;
                    opacity: 0.5;
                }

                .material-switch > input[type="checkbox"]:checked + label::after {
                    background: inherit;
                    left: 20px;
                }
            </style>

            <script type="text/javascript">
        //Блок глобальных переменных
        var epidemi_steps = 0; // Переменная количества шагов эпидемии в текущем графе

        // Статистика
        var num_nodes = 0; //Текущее количество верши
        var num_links = 0; //Количество ребер
        var loop_links = 0; //Текущее количество петель
        var twisted_links = 0; //Количество дополнительных дуг
        var unidirectional_links = 0; //Количество только однонаправленных дуг
        var bidirectional_links = 0; //Количество двунаправленных дуг
        var weight_net = 0.0; //Вес всей сети по ребрам

        //Класс для тем - одиночная модель
        function TemClass(options) {
            var _this1 = this;
            this.Selected = []; // Выбранные номера

            function Verticles(options) {
                this.Infected = [];
                this.Protected = [];
                this.Latent = [];
                this.Died = [];
                this.Susceptible = [];
            }

            this.makeRiskAndChance = function () {
                for (var i = 0; i < _this1.Traffic.Infected.length; i++) {
                    _this1.Risk.push(_this1.Traffic.Infected[i] + _this1.Traffic.Latent[i] + _this1.Traffic.Died[i]);
                    _this1.dRisk.push(_this1.dTraffic.Infected[i] + _this1.dTraffic.Latent[i] + _this1.dTraffic.Died[i]);
                    _this1.Chance.push(_this1.Traffic.Susceptible[i] + _this1.Traffic.Protected[i]);
                    _this1.dChance.push(_this1.dTraffic.Susceptible[i] + _this1.dTraffic.Protected[i]);
                }
            }

            this.Nodes = new Verticles();
            this.dNodes = new Verticles();
            this.Traffic = new Verticles();
            this.dTraffic = new Verticles();
            this.Risk = [];
            this.dRisk = [];
            this.Chance = [];
            this.dChance = [];
        }

        var TemsObjects = [];

        for (var d = 0; d < 7; d++) {
            TemsObjects[d] = new TemClass();
        }

        //Класс для тем - двойная модель
        function TemClassTwo(options) {
            var _this2 = this;
            this.Selected1 = []; // Выбранные номера
            this.Selected2 = []; // Выбранные номера

            function Verticles(options) {
                this.Infected1 = [];
                this.Infected2 = [];
                this.Protected1 = [];
                this.Protected2 = [];
                this.Latent1 = [];
                this.Latent2 = [];
                this.Died = [];
                this.Susceptible = [];
            }

            this.makeRiskAndChance = function () {
                for (var i = 0; i < _this2.Traffic.Infected1.length; i++) {
                    _this2.Chance1.push(_this2.Traffic.Infected1[i] + _this2.Traffic.Latent1[i]);
                    _this2.Chance2.push(_this2.Traffic.Infected2[i] + _this2.Traffic.Latent2[i]);
                    _this2.Chance21.push(_this2.Traffic.Infected2[i] + _this2.Traffic.Latent2[i] - _this2.Traffic.Infected1[i] - _this2.Traffic.Latent1[i]);
                    _this2.Chance12.push(_this2.Traffic.Infected1[i] + _this2.Traffic.Latent1[i] - _this2.Traffic.Infected2[i] - _this2.Traffic.Latent2[i]);

                    _this2.dChance1.push(_this2.dTraffic.Infected1[i] + _this2.dTraffic.Latent1[i]);
                    _this2.dChance2.push(_this2.dTraffic.Infected2[i] + _this2.dTraffic.Latent2[i]);
                    _this2.dChance21.push(_this2.dTraffic.Infected2[i] + _this2.dTraffic.Latent2[i] - _this2.dTraffic.Infected1[i] - _this2.dTraffic.Latent1[i]);
                    _this2.dChance12.push(_this2.dTraffic.Infected1[i] + _this2.dTraffic.Latent1[i] - _this2.dTraffic.Infected2[i] - _this2.dTraffic.Latent2[i]);

                    _this2.Risk1.push(1 - _this2.Traffic.Infected1[i] - _this2.Traffic.Latent1[i]);
                    _this2.Risk2.push(1 - _this2.Traffic.Infected2[i] - _this2.Traffic.Latent2[i]);
                    _this2.Risk21.push(-_this2.Traffic.Infected2[i] - _this2.Traffic.Latent2[i] + _this2.Traffic.Infected1[i] + _this2.Traffic.Latent1[i]);
                    _this2.Risk12.push(-_this2.Traffic.Infected1[i] - _this2.Traffic.Latent1[i] + _this2.Traffic.Infected2[i] + _this2.Traffic.Latent2[i]);

                    _this2.dRisk1.push(1 - _this2.dTraffic.Infected1[i] - _this2.dTraffic.Latent1[i]);
                    _this2.dRisk2.push(1 - _this2.dTraffic.Infected2[i] - _this2.dTraffic.Latent2[i]);
                    _this2.dRisk21.push(-_this2.dTraffic.Infected2[i] - _this2.dTraffic.Latent2[i] + _this2.dTraffic.Infected1[i] + _this2.dTraffic.Latent1[i]);
                    _this2.dRisk12.push(-_this2.dTraffic.Infected1[i] - _this2.dTraffic.Latent1[i] + _this2.dTraffic.Infected2[i] + _this2.dTraffic.Latent2[i]);
                }
            }

            this.Nodes = new Verticles();
            this.dNodes = new Verticles();
            this.Traffic = new Verticles();
            this.dTraffic = new Verticles();

            this.Risk1 = [];
            this.Risk2 = [];
            this.dRisk1 = [];
            this.dRisk2 = [];

            this.Chance1 = [];
            this.Chance2 = [];
            this.dChance1 = [];
            this.dChance2 = [];

            this.Risk12 = [];
            this.Risk21 = [];
            this.dRisk12 = [];
            this.dRisk21 = [];

            this.Chance12 = [];
            this.Chance21 = [];
            this.dChance12 = [];
            this.dChance21 = [];
        }

        var TemsObjectsTwo = [];

        for (var s = 0; s < 1; s++) {
            TemsObjectsTwo[s] = new TemClassTwo();
        }

        // Массив для микрофрактальных вероятностей
        var masMicrofractalP = [];
        masMicrofractalP[0] = [0.20, 0.20, 0.20, 0.20, 0.20];
        masMicrofractalP[1] = [0.21, 0.21, 0.21, 0.21, 0.21];
        masMicrofractalP[2] = [0.22, 0.22, 0.22, 0.22, 0.22];
        masMicrofractalP[3] = [0.23, 0.23, 0.23, 0.23, 0.23];
        masMicrofractalP[4] = [0.24, 0.24, 0.24, 0.24, 0.24];
        masMicrofractalP[5] = [0.25, 0.25, 0.25, 0.25, 0.25];
        masMicrofractalP[6] = [0.26, 0.26, 0.26, 0.26, 0.26];

        // Переменные для полей, чекбоксов, списков
        var save_num_nodes = 20; // 20 вершин по умолчанию

        // 4 вероятности
        var save_pe = 0.5;
        var save_pi = 0.33;
        var save_pr = 0.5;
        var save_pam = 0.33;

        // Количесво шагов
        var save_num_steps = 10;

        // Количесво шагов эпидемии уменьшающееся
        var save_num_steps_recurce = 10;

        // Время шага эпидемии
        var wait_time = 100;

        // Цвета вершин
        var I_color = "Black";
        var E_color = "Blue";
        var R_color = "Red";
        var S_color = "Grey";
        var AM_color = "Green";

        // Цвета букв
        var I_letter_color = "White";
        var E_letter_color = "White";
        var R_letter_color = "White";
        var S_letter_color = "White";
        var AM_letter_color = "White";

        // Доп. цвета
        var Line_color = "coral";
        var Infected_color = "Orange";

        // Чекбокс P
        var isLayeredDisplayP = false;

        // Для html
        var microfractal_html_save = '';
        var lines_microfractal = 1; // Всего строк в микрофрактале
        var selected_tematic = 0; // Выбранный микрофрактал
        var tematic_changed = false;
        var selected_tem1 = 0; // Выбранная тема для двойной модели
        var selected_tem2 = 0; // Выбранная тема для двойной модели

        // Для графиков
        var selected_status = 0;
        var isOnlyTems = false;
        var selectedGraphicType = 0;

        // Для эпидемии
        var stopepidemiFlag = false;
        var pauseepidemiFlag = false;
        var disabledMenuFlag = false;

        // Для меню "Риск- анализа"
        var riskAnalisChoice = 0;
        var isRiskAndChance = false;

        //Укладка
        var save_name_layout = "FR";
        var save_name_overlap = "FSA";
        var save_name_random = "AlbertBarabasi";

        // Для меню
        var ui_nav_save = 0;

        // Эпидемия
        var coeff_reposts = 100;
        var isFirstStepEpidemi = true;

        // Zoom
        var save_zoom_x = 0.0;
        var save_zoom_y = 0.0;
        var save_zoom_scale = 0.0;

        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        //класс для моделирования микрофрактала
        function MicroFractalGraph(options) {
            //склеивание полей объектов - для первой загрузки
            $.extend(
                    this
                , {
                    placeholder: $('#svg_container2').get(0)
                    , width: 800
                    , height: 400
                    , scaleExtent: [0.01, 100]
                    , node_radius: 7
                    , link_weight: 1
                    , link_distance: 65
                }
                , options
            );

            // Переменные для функций
            var statusInfekcii = "Infected";

            var zoom = d3.behavior.zoom()
                .scaleExtent(this.scaleExtent)
                .on("zoom", function () {
                    container.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
                });

            zoom.translate([300, 100]).scale(2);

            var svg = d3.select(this.placeholder).append("svg")
                .attr("width", this.width)
                .attr("height", this.height)

            var container = svg.append("g");
            var _this = this;

            this.saveP = function () {
                for (var i = 0; i < lines_microfractal; i++) {

                    var pi = $('input[name=microfractal_' + (i + 1) + '_' + 1 + ']').val();
                    var pr = $('input[name=microfractal_' + (i + 1) + '_' + 2 + ']').val();
                    var pe = $('input[name=microfractal_' + (i + 1) + '_' + 3 + ']').val();
                    var pam = $('input[name=microfractal_' + (i + 1) + '_' + 4 + ']').val();

                    masMicrofractalP[i][0] = pi;
                    masMicrofractalP[i][1] = pr;
                    masMicrofractalP[i][2] = pe;
                    masMicrofractalP[i][3] = pam;
                }
            }

            // Сохранить коэффициент репостов
            this.saveCoeffReposts = function () {
                coeff_reposts = $('input[name=input_coeff_reposts]').val();
            }

            // Сохранить две темы для двойной модели
            this.saveSelectedTems = function () {
                selected_tem1 = $('#name_tem1').val();
                selected_tem2 = $('#name_tem2').val();
            }
        }

        var microFractalGraph = new MicroFractalGraph();

        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        //класс для моделирования сети
        function NetworkGraph(options) {
            //склеивание полей объектов - для первой загрузки
            $.extend(
                    this
                , {
                    placeholder: $('#svg_container').get(0)
                    , width: 280
                    , height: 600
                    , scaleExtent: [0.04, 8]
                    , node_radius: 7
                    , link_weight: 1
                    , link_distance: 65
                }
                , options
            );

            // Переменные для функций
            var statusInfekcii = "Infected";

            var first = true;
            var zoom = d3.behavior.zoom()
                .scaleExtent(this.scaleExtent)
                .on("zoom", function () {
                    container.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
                });

            //Первоначальное увеличение
            zoom.translate([400, 250]).scale(1);

            var svg = d3.select(this.placeholder).append("svg")
                .attr("width", this.width)
                .attr("height", this.height)
                .call(zoom);

            var container = svg.append("g");
            var containerRects = svg.append("g");

            // добавляем контейнер графика в плейсхолдер
            var placeholder2 = $('#svg_container3').get(0);

            // создание объекта svg
            var svg_diagram = d3.select(placeholder2).append("svg")
                    .attr("class", "axis")
                    .attr("width", 850)
                    .attr("height", 600);

            this.isLayeredDisplay = false;
            var _this = this;

            // Чекбокс "Урезать слои"
            this.isLayeredDisplayCut = false;
            this.save_dx = 100;
            this.save_dy = 50;
            this.save_letter = 28;

            // Чекбокс "Ч/Б"
            this.isWBPrint = false;
            this.isWBNeed = false;

            // Чекбоксы
            this.isTwoModel = false;
            this.isSetSum = true;
            this.isSetRisk = false;
            this.isSetLinScale = true;

            // Растянуть график
            this.isStratched = false;

            // Начальное смещение
            container.attr("transform", "translate(400,250)scale(1)");

            ///////////////////////////////
            // Функция обращения к контроллеру за сгенерированной сетью
            this.generateNet = function () {

                $.ajax({
                    url: '/Main/NetworkBuilder'
                    , type: 'POST'
                    , dataType: "json"
                    , data: { num_nodes: save_num_nodes, random_links: $('input[name=random_links]').val(), name_layout: $("#name_layout option:selected").val(), name_overlap: save_name_overlap, name_random: $("#name_random option:selected").val(), random_degree: $('input[name=random_degree]').val() }
                    , success: function (data) {
                        if (data.success) {
                            //var data_tmp = $.extend(true,{}, data);
                            //console.debug(data_tmp);
                            _this.refreshNet(data);
                        }
                    }
                });

            }

            ////////////////////////////////////////Функции сохранений //////////////////////////////////////////////
            this.saveNumNodesAndGenerate = function () {
                save_num_nodes = $('input[name=num_nodes]').val();

                // ограничение на 1000 вершин
                if (save_num_nodes > 1000) {
                    save_num_nodes = 1000;
                    ui.displayMessage([{ message: "Ограничение на количество вершин = 1000", type: "warning" }]);
                }
                else {
                    this.generateNet(); ui.nav.click(3)
                }
            }

            this.saveNumSteps = function () {
                save_num_steps = $('input[name=num_steps]').val();
                wait_time = $('input[name=wait_time]').val();
                // ограничение на 600 шагов
                if (save_num_steps > 600) { save_num_steps = 600; }
            }

            this.saveDLays = function () {
                this.save_dx = $('input[name=grid_dx]').val();
                this.save_dy = $('input[name=grid_dy]').val();
                this.save_letter = $('input[name=letter]').val();
            }

            this.saveNameLayout = function () {
                save_name_layout = $("#name_layout option:selected").val();
            }

            this.saveNameRandom = function () {
                save_name_random = $("#name_random option:selected").val();
            }

            function choseStatusNode(data) {
                statusInfekcii = data.lable;
                Infected_color = data.color;
            }

            this.addColor = function (data) {
                if (this.isTwoModel == false) {
                    statusInfekcii = "Infected";
                    Infected_color = "Orange";
                    container.selectAll(".node").style('fill', (function (d) { if (d.nodeNum === data.nodeNum) { TemsObjects[selected_tematic].Selected.push(d.nodeNum.toString()); return data.color = Infected_color; } else return d.color; }));
                }
                else {
                    if (statusInfekcii == "Infected1") {
                        container.selectAll(".node").style('fill', (function (d) { if (d.nodeNum === data.nodeNum) { TemsObjectsTwo[0].Selected1.push(d.nodeNum.toString()); return data.color = Infected_color; } else return d.color; }));
                    }
                    else {
                        container.selectAll(".node").style('fill', (function (d) { if (d.nodeNum === data.nodeNum) { TemsObjectsTwo[0].Selected2.push(d.nodeNum.toString()); return data.color = Infected_color; } else return d.color; }));
                    }
                }
            }

            // Функция "Растянуть график"
            this.toggleStretch = function (data) {
                if (this.isStratched == false) this.isStratched = true;
                else this.isStratched = false;
            }

            // Функция "На центр"
            this.toCenter = function (data) {
                container.attr("transform", "translate(" + save_zoom_x + "," + save_zoom_y + ")scale(" + save_zoom_scale + ")");
                zoom.translate([save_zoom_x, save_zoom_y]).scale(save_zoom_scale);
            }

            // Функция "Установить центр"
            this.setCenter = function (data) {
                var x_min = data["grid"]["x_min"];
                var y_min = data["grid"]["y_min"];
                var x_max = data["grid"]["x_max"];
                var y_max = data["grid"]["y_max"];

                var x_center = 0;
                var y_center = 0;
                var center_scale = 1.0;

                var margin_x = 60;
                var margin_y = 60;

                if (save_num_nodes < 99) {
                    margin_x = 160;
                    margin_y = 160;
                }

                var dx = x_max - x_min + margin_x;
                var dy = y_max - y_min + margin_y;

                // х больше, значит масштаб по х
                if ((dx / 850) > (dy / 600)) {
                    center_scale = 850 / dx;
                    x_center = (850 - (dx - margin_x) * center_scale) / 2 - x_min * center_scale;
                    y_center = (600 - (dy - margin_y) * center_scale) / 2 - y_min * center_scale;
                }
                else {
                    center_scale = 600 / dy;
                    x_center = (850 - (dx - margin_x) * center_scale) / 2 - x_min * center_scale;
                    y_center = (600 - (dy - margin_y) * center_scale) / 2 - y_min * center_scale;
                }

                container.attr("transform", "translate(" + x_center + "," + y_center + ")scale(" + center_scale + ")");
                zoom.translate([x_center, y_center]).scale(center_scale);

                save_zoom_x = x_center;
                save_zoom_y = y_center;
                save_zoom_scale = center_scale;
            }

            // Функция обновления сети/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
            this.refreshNet = function (data) {

                // Установим данные центрирования картинки ровно по центру
                _this.setCenter(data);

                //Подсчитываем количество точек и ребер в графе
                num_nodes = data.nodes.length;
                num_links = data.links.length;

                var self = this;

                // Очистим от старого графа
                container.selectAll(".link").remove();
                container.selectAll(".node").remove();
                container.selectAll("line").remove(); //Для сетки
                container.selectAll("text").remove();//Для сетки
                container.selectAll("g").remove();

                //                container.attr("transform", "translate(400,250)scale(1)");

                var link = container.selectAll(".link")
                                                .data(data.links)
                                                .enter().append("line")
                                                .attr("class", "link")
                                                //.style('marker-start', function (d) { return 'url(#start-arrow)' })
                                                //.style('marker-end', function (d) { return d.right ? 'url(#end-arrow)' : ''; })
                                                .style("stroke-width", function (d) { return self.link_weight - 0 });

                var node = container.selectAll(".node")
                                .data(data.nodes)
                                .enter().append("circle")
                                .attr("class", "node")
                                .attr("r", function (d) { return self.node_radius - 0 })
                                .style("fill", function (d) { return d.color })
                                .on("mousedown", function (d) { return _this.addColor(d); });

                // Подписываем узлы
                node.append("title").text(function (d) { return "Номер: " + d.nodeId + " Соседей: " + d.weight + " Вес: " + d.nodeWeight + " Слой: " + d.layer + " Статус: " + d.status; });

                //значения объектов поместили в контейнер
                link.attr("x1", function (d) { return d.x_source; })
                        .attr("y1", function (d) { return d.y_source; })
                        .attr("x2", function (d) { return d.x_target; })
                        .attr("y2", function (d) { return d.y_target; });

                var x_min = 9999;
                var y_min = 9999;
                var x_max = 0;
                var y_max = 0;
                var layers = 0;
                var x_step = 100;
                var y_step = 50;

                if (this.isLayeredDisplay) {
                    x_min = data["grid"]["x_min"];
                    y_min = data["grid"]["y_min"];
                    x_max = data["grid"]["x_max"];
                    y_max = data["grid"]["y_max"];
                    layers = data["grid"]["count_layers"];
                    x_step = data["grid"]["rasst_x"];
                    y_step = data["grid"]["rasst_y"];
                }

                node.attr("cx", function (d) { return d.x_coordinate; })
                        .attr("cy", function (d) { return d.y_coordinate; });

                if (this.isLayeredDisplay) {
                    if (this.isLayeredDisplayCut) {
                        //Draw the line
                        var lay_count = data["lay_count"];
                        //                 document.write(lays_count);
                        for (var i = 0; i < lay_count; i++) {
                            container.append("line") //var cursor =
                             .attr("x1", x_min - x_step)
                             .attr("y1", y_min + y_step / 2 + y_step * i)
                             .attr("x2", x_max + x_step + 80)
                             .attr("y2", y_min + y_step / 2 + y_step * i)
                             .attr("stroke-width", 1)
                             .attr("stroke", Line_color);
                            //Draw the text
                            container.append("text") //var text =
                                            .attr("x", x_max + x_step)
                                            .attr("y", y_min + y_step / 2 + y_step * i - 5)
                                            .text("k = " + data["lays"][lay_count - i - 1]["num"])
                                            .attr("font-family", "sans-serif")
                                            .attr("font-size", this.save_letter + "px")
                                            .attr("fill", "Black");
                        }
                    }
                    else {
                        for (var j = 0; j < layers; j++) {
                            container.append("line") //var cursor =
                             .attr("x1", x_min - x_step)
                             .attr("y1", y_min + y_step / 2 + y_step * j)
                             .attr("x2", x_max + x_step + 80)
                             .attr("y2", y_min + y_step / 2 + y_step * j)
                             .attr("stroke-width", 1)
                             .attr("stroke", Line_color);
                            //Draw the text
                            container.append("text") //var text =
                                            .attr("x", x_max + x_step)
                                            .attr("y", y_min + y_step / 2 + y_step * j - 5)
                                            .text("k = " + (layers - j))
                                            .attr("font-family", "sans-serif")
                                            .attr("font-size", this.save_letter + "px")
                                            .attr("fill", "Black");
                        }
                    }

                }

                //Add the SVG Text Element to the svgContainer

                var text = container.selectAll(".text")
                                        .data(data.nodes)
                                        .enter()
                                        .append("text");

                var text2 = container.selectAll(".text")
                            .data(data.nodes)
                            .enter()
                            .append("text");
                //Буквы
                var textLabels2 = text2
                                 .attr("x", function (d) {
                                     if (d.letter == "I") return d.x_coordinate - 1;
                                     if (d.letter == "A+M") return d.x_coordinate - 6.5;
                                     if (d.letter == "E") return d.x_coordinate - 3;
                                     if (d.letter == "S") return d.x_coordinate - 3;
                                     if (d.letter == "R") return d.x_coordinate - 3;
                                     if (d.letter == "I1") return d.x_coordinate - 3;
                                     if (d.letter == "A+M1") return d.x_coordinate - 6.5;
                                     if (d.letter == "E1") return d.x_coordinate - 5;
                                     if (d.letter == "I2") return d.x_coordinate - 3;
                                     if (d.letter == "A+M2") return d.x_coordinate - 6.5;
                                     if (d.letter == "E2") return d.x_coordinate - 5;
                                 })
                                 .attr("y", function (d) { return d.y_coordinate + 3; })
                                 .text(function (d) { return d.letter; })
                                 .attr("font-family", "sans-serif")
                                 .attr("font-size", function (d) {
                                     if (d.letter == "A+M") return "6px";
                                     if (d.letter == "A+M1") return "5px";
                                     if (d.letter == "A+M2") return "5px";
                                     return "8px";})
                                 .attr("fill", function (d) {
                                     if (d.letter == "I") return I_letter_color;
                                     if (d.letter == "A+M") return AM_letter_color;
                                     if (d.letter == "E") return E_letter_color;
                                     if (d.letter == "S") return S_letter_color;
                                     if (d.letter == "R") return R_letter_color;
                                     if (d.letter == "I1") return I_letter_color;
                                     if (d.letter == "A+M1") return AM_letter_color;
                                     if (d.letter == "E1") return E_letter_color;
                                     if (d.letter == "I2") return I_letter_color;
                                     if (d.letter == "A+M2") return AM_letter_color;
                                     if (d.letter == "E2") return E_letter_color;
                                 })
            }

            // Функция получения нужного массива для вывода
            this.getTempMas = function () {

                // Составляем общий Temp массив
                var masTemp = [];

                for (var i = 0; i < 5; i++) {
                    masTemp[i] = [];
                }

                // Риск: I + E + R
                if (isRiskAndChance) {
                    if (selectedGraphicType == 2) {
                        if (this.isSetSum) {
                            for (var i = 0; i < 5; i++) {
                                masTemp[i] = TemsObjects[i].Risk;
                            }
                        } else {
                            for (var i = 0; i < 5; i++) {
                                masTemp[i] = TemsObjects[i].dRisk;
                            }
                        }
                    }   // Шанс: S + AM
                    else if (selectedGraphicType == 3) {
                        if (this.isSetSum) {
                            for (var i = 0; i < 5; i++) {
                                masTemp[i] = TemsObjects[i].Chance;
                            }
                        } else {
                            for (var i = 0; i < 5; i++) {
                                masTemp[i] = TemsObjects[i].dChance;
                            }
                        }
                    }
                }
                // Не риск и шанс
                else {
                    // 5 соятояний вместе
                    if (isOnlyTems) {
                        if (this.isSetSum) {
                            if (selectedGraphicType == 0) {
                                masTemp[0] = TemsObjects[selected_tematic].Nodes.Infected;
                                masTemp[1] = TemsObjects[selected_tematic].Nodes.Protected;
                                masTemp[2] = TemsObjects[selected_tematic].Nodes.Latent;
                                masTemp[3] = TemsObjects[selected_tematic].Nodes.Died;
                                masTemp[4] = TemsObjects[selected_tematic].Nodes.Susceptible;
                            }
                            else {
                                masTemp[0] = TemsObjects[selected_tematic].Traffic.Infected;
                                masTemp[1] = TemsObjects[selected_tematic].Traffic.Protected;
                                masTemp[2] = TemsObjects[selected_tematic].Traffic.Latent;
                                masTemp[3] = TemsObjects[selected_tematic].Traffic.Died;
                                masTemp[4] = TemsObjects[selected_tematic].Traffic.Susceptible;
                            }
                        }
                        else {
                            if (selectedGraphicType == 0) {
                                masTemp[0] = TemsObjects[selected_tematic].dNodes.Infected;
                                masTemp[1] = TemsObjects[selected_tematic].dNodes.Protected;
                                masTemp[2] = TemsObjects[selected_tematic].dNodes.Latent;
                                masTemp[3] = TemsObjects[selected_tematic].dNodes.Died;
                                masTemp[4] = TemsObjects[selected_tematic].dNodes.Susceptible;
                            }
                            else {
                                masTemp[0] = TemsObjects[selected_tematic].dTraffic.Infected;
                                masTemp[1] = TemsObjects[selected_tematic].dTraffic.Protected;
                                masTemp[2] = TemsObjects[selected_tematic].dTraffic.Latent;
                                masTemp[3] = TemsObjects[selected_tematic].dTraffic.Died;
                                masTemp[4] = TemsObjects[selected_tematic].dTraffic.Susceptible;
                            }
                        }
                    }
                        // 5 состояний по отдельности
                    else {

                        if (selected_status == 0) {
                            if (this.isSetSum) {
                                if (selectedGraphicType == 0) for (var i = 0; i < 5; i++) masTemp[i] = TemsObjects[i].Nodes.Infected;
                                else for (var i = 0; i < 5; i++) masTemp[i] = TemsObjects[i].Traffic.Infected;
                            }
                            else {
                                if (selectedGraphicType == 0) for (var i = 0; i < 5; i++) masTemp[i] = TemsObjects[i].dNodes.Infected;
                                else for (var i = 0; i < 5; i++) masTemp[i] = TemsObjects[i].dTraffic.Infected;
                            }
                        }

                        if (selected_status == 1) {
                            if (this.isSetSum) {
                                if (selectedGraphicType == 0) for (var i = 0; i < 5; i++) masTemp[i] = TemsObjects[i].Nodes.Protected;
                                else for (var i = 0; i < 5; i++) masTemp[i] = TemsObjects[i].Traffic.Protected;
                            }
                            else {
                                if (selectedGraphicType == 0) for (var i = 0; i < 5; i++) masTemp[i] = TemsObjects[i].dNodes.Protected;
                                else for (var i = 0; i < 5; i++) masTemp[i] = TemsObjects[i].dTraffic.Protected;
                            }
                        }

                        if (selected_status == 2) {
                            if (this.isSetSum) {
                                if (selectedGraphicType == 0) for (var i = 0; i < 5; i++) masTemp[i] = TemsObjects[i].Nodes.Latent;
                                else for (var i = 0; i < 5; i++) masTemp[i] = TemsObjects[i].Traffic.Latent;
                            }
                            else {
                                if (selectedGraphicType == 0) for (var i = 0; i < 5; i++) masTemp[i] = TemsObjects[i].dNodes.Latent;
                                else for (var i = 0; i < 5; i++) masTemp[i] = TemsObjects[i].dTraffic.Latent;
                            }
                        }

                        if (selected_status == 3) {
                            if (this.isSetSum) {
                                if (selectedGraphicType == 0) for (var i = 0; i < 5; i++) masTemp[i] = TemsObjects[i].Nodes.Died;
                                else for (var i = 0; i < 5; i++) masTemp[i] = TemsObjects[i].Traffic.Died;
                            }
                            else {
                                if (selectedGraphicType == 0) for (var i = 0; i < 5; i++) masTemp[i] = TemsObjects[i].dNodes.Died;
                                else for (var i = 0; i < 5; i++) masTemp[i] = TemsObjects[i].dTraffic.Died;
                            }
                        }

                        if (selected_status == 4) {
                            if (this.isSetSum) {
                                if (selectedGraphicType == 0) for (var i = 0; i < 5; i++) masTemp[i] = TemsObjects[i].Nodes.Susceptible;
                                else for (var i = 0; i < 5; i++) masTemp[i] = TemsObjects[i].Traffic.Susceptible;
                            }
                            else {
                                if (selectedGraphicType == 0) for (var i = 0; i < 5; i++) masTemp[i] = TemsObjects[i].dNodes.Susceptible;
                                else for (var i = 0; i < 5; i++) masTemp[i] = TemsObjects[i].dTraffic.Susceptible;
                            }
                        }
                    }
                }

                return masTemp;
            }

            // Функция получения нужного массива для вывода
            this.getTempMasTwo = function () {

                // Составляем общий Temp массив
                var masTemp = [];

                for (var i = 0; i < 8; i++) {
                    masTemp[i] = [];
                }

                // Риск
                if (isRiskAndChance) {
                    if (selectedGraphicType == 22) {
                        if (this.isSetSum) {
                            masTemp[0] = TemsObjectsTwo[0].Risk1;
                            masTemp[1] = TemsObjectsTwo[0].Risk2;
                            masTemp[2] = TemsObjectsTwo[0].Risk12;
                            masTemp[3] = TemsObjectsTwo[0].Risk21;
                        } else {
                            masTemp[0] = TemsObjectsTwo[0].dRisk1;
                            masTemp[1] = TemsObjectsTwo[0].dRisk2;
                            masTemp[2] = TemsObjectsTwo[0].dRisk12;
                            masTemp[3] = TemsObjectsTwo[0].dRisk21;
                        }
                    }   // Шанс
                    else if ((selectedGraphicType == 2)||(selectedGraphicType == 3)) {
                        if (this.isSetSum) {
                            masTemp[0] = TemsObjectsTwo[0].Chance1;
                            masTemp[1] = TemsObjectsTwo[0].Chance2;
                            masTemp[2] = TemsObjectsTwo[0].Chance12;
                            masTemp[3] = TemsObjectsTwo[0].Chance21;
                        } else {
                            masTemp[0] = TemsObjectsTwo[0].dChance1;
                            masTemp[1] = TemsObjectsTwo[0].dChance2;
                            masTemp[2] = TemsObjectsTwo[0].dChance12;
                            masTemp[3] = TemsObjectsTwo[0].dChance21;
                        }
                    }
                }
                // Траффик и вершины
                else {
                    if (this.isSetSum) {
                        if (selectedGraphicType == 0) {
                            masTemp[0] = TemsObjectsTwo[0].Nodes.Infected1;
                            masTemp[1] = TemsObjectsTwo[0].Nodes.Infected2;
                            masTemp[2] = TemsObjectsTwo[0].Nodes.Protected1;
                            masTemp[3] = TemsObjectsTwo[0].Nodes.Protected2;
                            masTemp[4] = TemsObjectsTwo[0].Nodes.Latent1;
                            masTemp[5] = TemsObjectsTwo[0].Nodes.Latent2;
                            masTemp[6] = TemsObjectsTwo[0].Nodes.Died;
                            masTemp[7] = TemsObjectsTwo[0].Nodes.Susceptible;
                        }
                        else {
                            masTemp[0] = TemsObjectsTwo[0].Traffic.Infected1;
                            masTemp[1] = TemsObjectsTwo[0].Traffic.Infected2;
                            masTemp[2] = TemsObjectsTwo[0].Traffic.Protected1;
                            masTemp[3] = TemsObjectsTwo[0].Traffic.Protected2;
                            masTemp[4] = TemsObjectsTwo[0].Traffic.Latent1;
                            masTemp[5] = TemsObjectsTwo[0].Traffic.Latent2;
                            masTemp[6] = TemsObjectsTwo[0].Traffic.Died;
                            masTemp[7] = TemsObjectsTwo[0].Traffic.Susceptible;
                        }
                    }
                    else {
                        if (selectedGraphicType == 0) {
                            masTemp[0] = TemsObjectsTwo[0].dNodes.Infected1;
                            masTemp[1] = TemsObjectsTwo[0].dNodes.Infected2;
                            masTemp[2] = TemsObjectsTwo[0].dNodes.Protected1;
                            masTemp[3] = TemsObjectsTwo[0].dNodes.Protected2;
                            masTemp[4] = TemsObjectsTwo[0].dNodes.Latent1;
                            masTemp[5] = TemsObjectsTwo[0].dNodes.Latent2;
                            masTemp[6] = TemsObjectsTwo[0].dNodes.Died;
                            masTemp[7] = TemsObjectsTwo[0].dNodes.Susceptible;
                        }
                        else {
                            masTemp[0] = TemsObjectsTwo[0].dTraffic.Infected1;
                            masTemp[1] = TemsObjectsTwo[0].dTraffic.Infected2;
                            masTemp[2] = TemsObjectsTwo[0].dTraffic.Protected1;
                            masTemp[3] = TemsObjectsTwo[0].dTraffic.Protected2;
                            masTemp[4] = TemsObjectsTwo[0].dTraffic.Latent1;
                            masTemp[5] = TemsObjectsTwo[0].dTraffic.Latent2;
                            masTemp[6] = TemsObjectsTwo[0].dTraffic.Died;
                            masTemp[7] = TemsObjectsTwo[0].dTraffic.Susceptible;
                        }
                    }
                }

                return masTemp;
            }

            //все для отрисовки графиков
            this.drawDiagram = function () {
                var height = 600,
                    width = 800,
                    margin = 75,

                data_infected = [];
                data_protected = [];
                data_latent = [];
                data_died = [];
                data_Susceptible = [];

                //Очистим на всякий случай
                svg_diagram.selectAll("line").remove();
                svg_diagram.selectAll("text").remove();
                svg_diagram.selectAll("g").remove();

                // длина оси X= ширина контейнера svg - отступ слева и справа
                var xAxisLength = width - 2 * margin;

                // длина оси Y = высота контейнера svg - отступ сверху и снизу
                var yAxisLength = height - 2 * margin;

                // ищем максимальные значения по x и y: по x - шагов, по у - всего точек
                var max_y = num_nodes;
                var min_y = 0.0;

                // График вершин
                if (selectedGraphicType == 0) { // Сумма
//                    if (this.isSetLinScale == true) max_y = num_nodes;
//                    else max_y = Math.log(num_nodes);
                    max_y = num_nodes;
                    min_y = 0.0;
                    if (this.isSetSum == false){ // Разность
                        max_y = num_nodes; // / 3.0;
                        min_y = -num_nodes;// / 3.0;
                    }
                }                // График трафика, риска и шанса
                else if ((selectedGraphicType == 1)||(selectedGraphicType == 2)||(selectedGraphicType == 3)) { // Сумма
                    max_y = 1;
                    min_y = 0.0;
                    if (this.isSetSum == false) { // Разность
                        max_y = 1; // / 3.0;
                        min_y = -1.0; // / 3.0;
                    }
                }

                // Составляем общий Temp массив
                var masTemp = _this.getTempMas();

                // Для растяжения графиков
                if (this.isStratched) {
                    var min_mas = [];
                    var max_mas = [];
                    var flag_minus = false;

                    if (masTemp[0].length != 0) min_mas.push(Math.min.apply(null, masTemp[0]));
                    if (masTemp[1].length != 0) min_mas.push(Math.min.apply(null, masTemp[1]));
                    if (masTemp[2].length != 0) min_mas.push(Math.min.apply(null, masTemp[2]));
                    if (masTemp[3].length != 0) min_mas.push(Math.min.apply(null, masTemp[3]));
                    if (masTemp[4].length != 0) min_mas.push(Math.min.apply(null, masTemp[4]));
                    if (min_mas.length != 0) {
                        var miny = Math.min.apply(null, min_mas);
                        if (miny > 0) min_y = 0;
                        else min_y = miny * 1.05;
                    }

                    if (masTemp[0].length != 0) max_mas.push(Math.max.apply(null, masTemp[0]));
                    if (masTemp[1].length != 0) max_mas.push(Math.max.apply(null, masTemp[1]));
                    if (masTemp[2].length != 0) max_mas.push(Math.max.apply(null, masTemp[2]));
                    if (masTemp[3].length != 0) max_mas.push(Math.max.apply(null, masTemp[3]));
                    if (masTemp[4].length != 0) max_mas.push(Math.max.apply(null, masTemp[4]));
                    if (max_mas.length != 0) {
                        var maxy = Math.max.apply(null, max_mas);
                        if (maxy < 0) max_y = 0;
                        else max_y = maxy * 1.05;
                    }
                }

                // функция интерполяции значений на ось Х
                var scaleX = d3.scale.linear()
                            .domain([0, save_num_steps])
                            .range([0, xAxisLength]);

                // функция интерполяции значений на ось Y
                var scaleY = d3.scale.linear()
                            .domain([max_y, min_y])
                            .range([0, yAxisLength]);

                // Заполнение графиков информацией
                var mas_length = TemsObjects[selected_tematic].Nodes.Infected.length;

                var mas_length1 = masTemp[0].length;
                var mas_length2 = masTemp[1].length;
                var mas_length3 = masTemp[2].length;
                var mas_length4 = masTemp[3].length;
                var mas_length5 = masTemp[4].length;
                // Заполняем график
                    for (var i = 0; i < mas_length; i++) {
                        data_infected.push({ x: scaleX(i) + margin, y: scaleY(masTemp[0][i]) + margin });
                        data_protected.push({ x: scaleX(i) + margin, y: scaleY(masTemp[1][i]) + margin });
                        data_latent.push({ x: scaleX(i) + margin, y: scaleY(masTemp[2][i]) + margin });
                        data_died.push({ x: scaleX(i) + margin, y: scaleY(masTemp[3][i]) + margin });
                        data_Susceptible.push({ x: scaleX(i) + margin, y: scaleY(masTemp[4][i]) + margin });
                    }

                // создаем ось X
                var xAxis = d3.svg.axis()
                             .scale(scaleX)
                             .orient("bottom");
                // создаем ось Y
                var yAxis = d3.svg.axis()
                             .scale(scaleY)
                             .orient("left");

                // отрисовка оси Х
                svg_diagram.append("g")
                     .attr("class", "x-axis")
                     .attr("transform",  // сдвиг оси вниз и вправо
                         "translate(" + margin + "," + (height - margin) + ")")
                    .call(xAxis);

                // отрисовка оси Y
                svg_diagram.append("g")
                    .attr("class", "y-axis")
                    .attr("transform", // сдвиг оси вниз и вправо на margin
                            "translate(" + margin + "," + margin + ")")
                    .call(yAxis);

                // создаем набор вертикальных линий для сетки
                svg_diagram.selectAll("g.x-axis g.tick")
                    .append("line")
                    .classed("grid-line", true)
                    .attr("x1", 0)
                    .attr("y1", 0)
                    .attr("x2", 0)
                    .attr("y2", -(yAxisLength));

                // рисуем горизонтальные линии координатной сетки
                svg_diagram.selectAll("g.y-axis g.tick")
                    .append("line")
                    .classed("grid-line", true)
                    .attr("x1", 0)
                    .attr("y1", 0)
                    .attr("x2", xAxisLength)
                    .attr("y2", 0);

                // функция, создающая по массиву точек линии
                var line = d3.svg.line()
                            .x(function (d) { return d.x; })
                            .y(function (d) { return d.y; });

                //Рисуем кривую
                // добавляем путь
                svg_diagram.append("g").append("path")
                .attr("d", line(data_infected))
                .style("stroke-dasharray", ("10, 10, 2, 10, 2, 10"))
                .style("stroke", I_color)
                .style("stroke-width", 2);

                svg_diagram.append("g").append("path")
                .attr("d", line(data_protected))
                .style("stroke-dasharray", ("7, 7, 2, 7"))
                .style("stroke", AM_color)
                .style("stroke-width", 2);

                svg_diagram.append("g").append("path")
                .attr("d", line(data_latent))
                .style("stroke-dasharray", ("24, 12"))
                .style("stroke", E_color)
                .style("stroke-width", 2);

                svg_diagram.append("g").append("path")
                .attr("d", line(data_died))
                .style("stroke-dasharray", ("3, 3"))
                .style("stroke", R_color)
                .style("stroke-width", 2);

                svg_diagram.append("g").append("path")
                .attr("d", line(data_Susceptible))
                .style("stroke-dasharray", ("0, 0"))
                .style("stroke", S_color)
                .style("stroke-width", 2);

                // Подписи
                // добавляем заголовок
/*                if (!isRiskAnalis) {
                    svg_diagram.append("g").append("text")
                        .attr("x", (width / 2))
                        .attr("y", margin - 10)
                        .attr("text-anchor", "middle")
                        .style("font-size", "15px")
                        .text("График эпидемии");

                    svg_diagram.append("g").append("text")
                        .attr("x", margin - 10)
                        .attr("y", margin - 20)
                        .attr("text-anchor", "start")
                        .style("font-size", "13px")
                        .text("Количество");

                    svg_diagram.append("g").append("text")
                        .attr("x", margin - 10)
                        .attr("y", margin - 11)
                        .attr("text-anchor", "start")
                        .style("font-size", "13px")
                        .text("вершин");
                }
                else {
                        if (riskAnalisChoice == 0)
                            svg_diagram.append("g").append("text")
                            .attr("x", margin - 10)
                            .attr("y", margin - 11)
                            .attr("text-anchor", "start")
                            .style("font-size", "13px")
                            .text("P");

                        else if (riskAnalisChoice == 1)
                            svg_diagram.append("g").append("text")
                            .attr("x", margin - 10)
                            .attr("y", margin - 11)
                            .attr("text-anchor", "start")
                            .style("font-size", "13px")
                            .text("Ущерб");

                        else if (riskAnalisChoice == 2)
                            svg_diagram.append("g").append("text")
                            .attr("x", margin - 10)
                            .attr("y", margin - 11)
                            .attr("text-anchor", "start")
                            .style("font-size", "13px")
                            .text("dP");

                        else if (riskAnalisChoice == 3)
                            svg_diagram.append("g").append("text")
                            .attr("x", margin - 10)
                            .attr("y", margin - 11)
                            .attr("text-anchor", "start")
                            .style("font-size", "13px")
                            .text("dU");
                }*/

                svg_diagram.append("g").append("text")
                    .attr("x", width - margin + 30)
                    .attr("y", height - margin - 14)
                    .attr("text-anchor", "end")
                    .style("font-size", "13px")
                    .text("Дискретное");

                svg_diagram.append("g").append("text")
                    .attr("x", width - margin + 30)
                    .attr("y", height - margin - 5)
                    .attr("text-anchor", "end")
                    .style("font-size", "13px")
                    .text("время");

                // Стрелки
                // define arrow markers for graph links
                svg_diagram.append('svg:defs').append('svg:marker')
                    .attr('id', 'end-arrow')
                    .attr('viewBox', '0 -5 10 10')
                    .attr('refX', 15) //сдвиг
                    .attr('markerWidth', 4) //размер
                    .attr('markerHeight', 6) //размер
                    .attr('orient', 'auto')
                  .append('svg:path')
                    .attr('d', 'M0,-5L10,0L0,5')
                    .attr('fill', '#000')
                    .style("stroke", "grey");

                var part = Math.floor(save_num_steps / 5);
                //5 букв - подписей
                //
           //     document.write(data_died.length);
                if (isOnlyTems && !isRiskAndChance) {
                    if (mas_length >= (part - 1)) {
                        svg_diagram.append("g").append("text")
                            .attr("x", data_Susceptible[part - 1].x + 42)
                            .attr("y", data_Susceptible[part - 1].y - 32) // - margin - 15)
                            .attr("text-anchor", "end")
                            .style("font-size", "14px")
                            .text("S");

                        svg_diagram.append("line")
                            .attr("x1", data_Susceptible[part - 1].x + 30)
                            .attr("y1", data_Susceptible[part - 1].y - 30)
                            .attr("x2", data_Susceptible[part - 1].x)
                            .attr("y2", data_Susceptible[part - 1].y)
                            .attr("class", "link")
                            .style('marker-end', 'url(#end-arrow)')
                            .style("stroke-width", 1.5);
                    }
                    if (mas_length >= (part * 2 - 1)) {
                        svg_diagram.append("g").append("text")
                            .attr("x", data_died[part * 2 - 1].x + 42)
                            .attr("y", data_died[part * 2 - 1].y - 32) // - margin - 15)
                            .attr("text-anchor", "end")
                            .style("font-size", "14px")
                            .text("R");

                        svg_diagram.append("line")
                            .attr("x1", data_died[part * 2 - 1].x + 30)
                            .attr("y1", data_died[part * 2 - 1].y - 30)
                            .attr("x2", data_died[part * 2 - 1].x)
                            .attr("y2", data_died[part * 2 - 1].y)
                            .attr("class", "link")
                            .style('marker-end', 'url(#end-arrow)')
                            .style("stroke-width", 1.5);
                    }
                    if (mas_length >= (part * 3 - 1)) {
                        svg_diagram.append("g").append("text")
                            .attr("x", data_protected[part * 3 - 1].x + 46)
                            .attr("y", data_protected[part * 3 - 1].y - 32) // - margin - 15)
                            .attr("text-anchor", "end")
                            .style("font-size", "14px")
                            .text("A+M");

                        svg_diagram.append("line")
                            .attr("x1", data_protected[part * 3 - 1].x + 30)
                            .attr("y1", data_protected[part * 3 - 1].y - 30)
                            .attr("x2", data_protected[part * 3 - 1].x)
                            .attr("y2", data_protected[part * 3 - 1].y)
                            .attr("class", "link")
                            .style('marker-end', 'url(#end-arrow)')
                            .style("stroke-width", 1.5);
                    }
                    if (mas_length >= part * 4 - 1) {
                        svg_diagram.append("g").append("text")
                            .attr("x", data_latent[part * 4 - 1].x + 42)
                            .attr("y", data_latent[part * 4 - 1].y - 32) // - margin - 15)
                            .attr("text-anchor", "end")
                            .style("font-size", "14px")
                            .text("E");

                        svg_diagram.append("line")
                            .attr("x1", data_latent[part * 4 - 1].x + 30)
                            .attr("y1", data_latent[part * 4 - 1].y - 30)
                            .attr("x2", data_latent[part * 4 - 1].x)
                            .attr("y2", data_latent[part * 4 - 1].y)
                            .attr("class", "link")
                            .style('marker-end', 'url(#end-arrow)')
                            .style("stroke-width", 1.5);
                    }
                    if (mas_length >= part * 5 - 1) {
                        svg_diagram.append("g").append("text")
                            .attr("x", data_infected[part * 5 - 1].x + 42)
                            .attr("y", data_infected[part * 5 - 1].y - 32) // - margin - 15)
                            .attr("text-anchor", "end")
                            .style("font-size", "14px")
                            .text("I");

                        svg_diagram.append("line")
                            .attr("x1", data_infected[part * 5 - 1].x + 30)
                            .attr("y1", data_infected[part * 5 - 1].y - 30)
                            .attr("x2", data_infected[part * 5 - 1].x)
                            .attr("y2", data_infected[part * 5 - 1].y)
                            .attr("class", "link")
                            .style('marker-end', 'url(#end-arrow)')
                            .style("stroke-width", 1.5);
                    }
                } else {
                    if (mas_length1 >= (part - 1)) {
                        svg_diagram.append("g").append("text")
                            .attr("x", data_infected[part - 1].x + 42)
                            .attr("y", data_infected[part - 1].y - 32) // - margin - 15)
                            .attr("text-anchor", "end")
                            .style("font-size", "14px")
                            .text("T1");

                        svg_diagram.append("line")
                            .attr("x1", data_infected[part - 1].x + 30)
                            .attr("y1", data_infected[part - 1].y - 30)
                            .attr("x2", data_infected[part - 1].x)
                            .attr("y2", data_infected[part - 1].y)
                            .attr("class", "link")
                            .style('marker-end', 'url(#end-arrow)')
                            .style("stroke-width", 1.5);
                    }
                    if (mas_length2 >= (part * 2 - 1)) {
                        svg_diagram.append("g").append("text")
                            .attr("x", data_protected[part * 2 - 1].x + 42)
                            .attr("y", data_protected[part * 2 - 1].y - 32) // - margin - 15)
                            .attr("text-anchor", "end")
                            .style("font-size", "14px")
                            .text("T2");

                        svg_diagram.append("line")
                            .attr("x1", data_protected[part * 2 - 1].x + 30)
                            .attr("y1", data_protected[part * 2 - 1].y - 30)
                            .attr("x2", data_protected[part * 2 - 1].x)
                            .attr("y2", data_protected[part * 2 - 1].y)
                            .attr("class", "link")
                            .style('marker-end', 'url(#end-arrow)')
                            .style("stroke-width", 1.5);
                    }
                    if (mas_length3 >= (part * 3 - 1)) {
                        svg_diagram.append("g").append("text")
                            .attr("x", data_latent[part * 3 - 1].x + 46)
                            .attr("y", data_latent[part * 3 - 1].y - 32) // - margin - 15)
                            .attr("text-anchor", "end")
                            .style("font-size", "14px")
                            .text("T3");

                        svg_diagram.append("line")
                            .attr("x1", data_latent[part * 3 - 1].x + 30)
                            .attr("y1", data_latent[part * 3 - 1].y - 30)
                            .attr("x2", data_latent[part * 3 - 1].x)
                            .attr("y2", data_latent[part * 3 - 1].y)
                            .attr("class", "link")
                            .style('marker-end', 'url(#end-arrow)')
                            .style("stroke-width", 1.5);
                    }
                    if (mas_length4 >= part * 4 - 1) {
                        svg_diagram.append("g").append("text")
                            .attr("x", data_died[part * 4 - 1].x + 42)
                            .attr("y", data_died[part * 4 - 1].y - 32) // - margin - 15)
                            .attr("text-anchor", "end")
                            .style("font-size", "14px")
                            .text("T4");

                        svg_diagram.append("line")
                            .attr("x1", data_died[part * 4 - 1].x + 30)
                            .attr("y1", data_died[part * 4 - 1].y - 30)
                            .attr("x2", data_died[part * 4 - 1].x)
                            .attr("y2", data_died[part * 4 - 1].y)
                            .attr("class", "link")
                            .style('marker-end', 'url(#end-arrow)')
                            .style("stroke-width", 1.5);
                    }
                    if (mas_length5 >= part * 5 - 1) {
                        svg_diagram.append("g").append("text")
                            .attr("x", data_Susceptible[part * 5 - 1].x + 42)
                            .attr("y", data_Susceptible[part * 5 - 1].y - 32) // - margin - 15)
                            .attr("text-anchor", "end")
                            .style("font-size", "14px")
                            .text("T5");

                        svg_diagram.append("line")
                            .attr("x1", data_Susceptible[part * 5 - 1].x + 30)
                            .attr("y1", data_Susceptible[part * 5 - 1].y - 30)
                            .attr("x2", data_Susceptible[part * 5 - 1].x)
                            .attr("y2", data_Susceptible[part * 5 - 1].y)
                            .attr("class", "link")
                            .style('marker-end', 'url(#end-arrow)')
                            .style("stroke-width", 1.5);
                    }
                }

                //Добавляем легенду
                var strokes = 5;
                if (isOnlyTems && !isRiskAndChance) {
                    var data_legend = [
                            { "status": "Infected", "color": I_color },
                            { "status": "Admined+Immunate", "color": AM_color },
                            { "status": "Latent", "color": E_color },
                            { "status": "Removed", "color": R_color },
                            { "status": "Susceptible", "color": S_color }
                    ];
                }
                else {
                    strokes = lines_microfractal;
                    var data_legend = [];
                    if (lines_microfractal >= 1)
                        data_legend.push({ "status": "Тема" + 1, "color": I_color });
                    if (lines_microfractal >= 2)
                        data_legend.push({ "status": "Тема" + 2, "color": AM_color });
                    if (lines_microfractal >= 3)
                        data_legend.push({ "status": "Тема" + 3, "color": E_color });
                    if (lines_microfractal >= 4)
                        data_legend.push({ "status": "Тема" + 4, "color": R_color });
                    if (lines_microfractal >= 5)
                        data_legend.push({ "status": "Тема" + 5, "color": S_color });
                }

                for (var i = 0; i < strokes; i++) {
                    //Draw the text
                    svg_diagram.append("g").append("text")
                                    .attr("x", width - 110)
                                    .attr("y", 8 + i * 11 + 10) //i * 11
                                    .text(data_legend[i].status)
                                    .attr("font-size", "14px");

                    //Draw the lines
                    svg_diagram.append("g").append("line")
                                             .attr("x1", width - 170)
                                             .attr("y1", i * 11 + 5 + 10)
                                             .attr("x2", width - 128 + 10)
                                             .attr("y2", i * 11 + 5 + 10)
                                             .style("stroke", function (d) { return data_legend[i].color; })
                                             .style("stroke-dasharray", function (d) {
                                                 if (i == 0) return ("10, 10, 2, 10, 2, 10");
                                                 else if (i == 1) return ("7, 7, 2, 7");
                                                 else if (i == 2) return ("24, 12");
                                                 else if (i == 3) return ("3, 3");
                                                 else return ("0, 0");
                                             });
                }
            }

            //все для отрисовки графиков для двойной модели
            this.drawDiagramTwo = function () {
                var height = 600,
                    width = 800,
                    margin = 75,

                data1 = [];
                data2 = [];
                data3 = [];
                data4 = [];
                data5 = [];
                data6 = [];
                data7 = [];
                data8 = [];

                //Очистим на всякий случай
                svg_diagram.selectAll("line").remove();
                svg_diagram.selectAll("text").remove();
                svg_diagram.selectAll("g").remove();

                // длина оси X= ширина контейнера svg - отступ слева и справа
                var xAxisLength = width - 2 * margin;

                // длина оси Y = высота контейнера svg - отступ сверху и снизу
                var yAxisLength = height - 2 * margin;

                // ищем максимальные значения по x и y: по x - шагов, по у - всего точек
                var max_y = num_nodes;
                var min_y = 0.0;

                // График вершин
                if (selectedGraphicType == 0) { // Сумма
                    max_y = num_nodes;
                    min_y = 0.0;
                    if (this.isSetSum == false) { // Разность
                        max_y = num_nodes;
                        min_y = -num_nodes;
                    }
                }                // График риска
                else { // Сумма
                    max_y = 1;
                    min_y = 0.0;
                    if (this.isSetSum == false) { // Разность
                        max_y = 1;
                        min_y = -1.0;
                    }
                }

                // Составляем общий Temp массив
                var masTempTwo = _this.getTempMasTwo();

                // Для растяжения графиков
                if (this.isStratched) {
                    var min_mas = [];
                    var max_mas = [];

                    if (masTempTwo[0].length != 0) min_mas.push(Math.min.apply(null, masTempTwo[0]));
                    if (masTempTwo[1].length != 0) min_mas.push(Math.min.apply(null, masTempTwo[1]));
                    if ((masTempTwo[2].length != 0) && (!isRiskAndChance)) min_mas.push(Math.min.apply(null, masTempTwo[2]));
                    if ((masTempTwo[3].length != 0) && (!isRiskAndChance)) min_mas.push(Math.min.apply(null, masTempTwo[3]));
                    if (masTempTwo[4].length != 0) min_mas.push(Math.min.apply(null, masTempTwo[4]));
                    if (masTempTwo[5].length != 0) min_mas.push(Math.min.apply(null, masTempTwo[5]));
                    if (masTempTwo[6].length != 0) min_mas.push(Math.min.apply(null, masTempTwo[6]));
                    if (masTempTwo[7].length != 0) min_mas.push(Math.min.apply(null, masTempTwo[7]));
                    if (min_mas.length != 0) {
                        var miny = Math.min.apply(null, min_mas);
                        if (miny > 0) min_y = 0;
                        else min_y = miny * 1.05;
                    }

                    if (masTempTwo[0].length != 0) max_mas.push(Math.max.apply(null, masTempTwo[0]));
                    if (masTempTwo[1].length != 0) max_mas.push(Math.max.apply(null, masTempTwo[1]));
                    if ((masTempTwo[2].length != 0)&&(!isRiskAndChance)) max_mas.push(Math.max.apply(null, masTempTwo[2]));
                    if ((masTempTwo[3].length != 0)&&(!isRiskAndChance)) max_mas.push(Math.max.apply(null, masTempTwo[3]));
                    if (masTempTwo[4].length != 0) max_mas.push(Math.max.apply(null, masTempTwo[4]));
                    if (masTempTwo[5].length != 0) max_mas.push(Math.max.apply(null, masTempTwo[5]));
                    if (masTempTwo[6].length != 0) max_mas.push(Math.max.apply(null, masTempTwo[6]));
                    if (masTempTwo[7].length != 0) max_mas.push(Math.max.apply(null, masTempTwo[7]));
                    if (max_mas.length != 0) {
                        var maxy = Math.max.apply(null, max_mas);
                        if (maxy < 0) max_y = 0;
                        else max_y = maxy * 1.05;
                    }
                }

                // функция интерполяции значений на ось Х
                var scaleX = d3.scale.linear()
                            .domain([0, save_num_steps])
                            .range([0, xAxisLength]);

                // функция интерполяции значений на ось Y
                var scaleY = d3.scale.linear()
                            .domain([max_y, min_y])
                            .range([0, yAxisLength]);

                // Заполнение графиков информацией
                var mas_length = TemsObjectsTwo[0].Nodes.Infected1.length;

                // Заполняем график
                if (!isRiskAndChance) {
                    for (var i = 0; i < mas_length; i++) {
                        data1.push({ x: scaleX(i) + margin, y: scaleY(masTempTwo[0][i]) + margin });
                        data2.push({ x: scaleX(i) + margin, y: scaleY(masTempTwo[1][i]) + margin });
                        data3.push({ x: scaleX(i) + margin, y: scaleY(masTempTwo[2][i]) + margin });
                        data4.push({ x: scaleX(i) + margin, y: scaleY(masTempTwo[3][i]) + margin });
                        data5.push({ x: scaleX(i) + margin, y: scaleY(masTempTwo[4][i]) + margin });
                        data6.push({ x: scaleX(i) + margin, y: scaleY(masTempTwo[5][i]) + margin });
                        data7.push({ x: scaleX(i) + margin, y: scaleY(masTempTwo[6][i]) + margin });
                        data8.push({ x: scaleX(i) + margin, y: scaleY(masTempTwo[7][i]) + margin });
                    }
                } else {
                    for (var i = 0; i < mas_length; i++) {
                        data1.push({ x: scaleX(i) + margin, y: scaleY(masTempTwo[0][i]) + margin });
                        data2.push({ x: scaleX(i) + margin, y: scaleY(masTempTwo[1][i]) + margin });
                        data3.push({ x: scaleX(i) + margin, y: scaleY(masTempTwo[2][i]) + margin });
                        data4.push({ x: scaleX(i) + margin, y: scaleY(masTempTwo[3][i]) + margin });
                    }
                }

                // создаем ось X
                var xAxis = d3.svg.axis()
                             .scale(scaleX)
                             .orient("bottom");
                // создаем ось Y
                var yAxis = d3.svg.axis()
                             .scale(scaleY)
                             .orient("left");

                // отрисовка оси Х
                svg_diagram.append("g")
                     .attr("class", "x-axis")
                     .attr("transform",  // сдвиг оси вниз и вправо
                         "translate(" + margin + "," + (height - margin) + ")")
                    .call(xAxis);

                // отрисовка оси Y
                svg_diagram.append("g")
                    .attr("class", "y-axis")
                    .attr("transform", // сдвиг оси вниз и вправо на margin
                            "translate(" + margin + "," + margin + ")")
                    .call(yAxis);

                // создаем набор вертикальных линий для сетки
                svg_diagram.selectAll("g.x-axis g.tick")
                    .append("line")
                    .classed("grid-line", true)
                    .attr("x1", 0)
                    .attr("y1", 0)
                    .attr("x2", 0)
                    .attr("y2", -(yAxisLength));

                // рисуем горизонтальные линии координатной сетки
                svg_diagram.selectAll("g.y-axis g.tick")
                    .append("line")
                    .classed("grid-line", true)
                    .attr("x1", 0)
                    .attr("y1", 0)
                    .attr("x2", xAxisLength)
                    .attr("y2", 0);

                // функция, создающая по массиву точек линии
                var line = d3.svg.line()
                            .x(function (d) { return d.x; })
                            .y(function (d) { return d.y; });

                //Рисуем кривую
                // добавляем путь
                svg_diagram.append("g").append("path")
                .attr("d", line(data1))
                .style("stroke-dasharray", ("7, 5, 2, 5"))
                .style("stroke", I_color)
                .style("stroke-width", 2);

                svg_diagram.append("g").append("path")
                .attr("d", line(data2))
                .style("stroke-dasharray", ("7, 5, 2, 5, 2, 5"))
                .style("stroke", I_color)
                .style("stroke-width", 2);

                if (!isRiskAndChance) {
                svg_diagram.append("g").append("path")
                .attr("d", line(data3))
                .style("stroke-dasharray", ("20, 5, 5, 5"))
                .style("stroke", AM_color)
                .style("stroke-width", 2);

                svg_diagram.append("g").append("path")
                .attr("d", line(data4))
                .style("stroke-dasharray", ("20, 5, 5, 5, 5, 5"))
                .style("stroke", AM_color)
                .style("stroke-width", 2);


                    svg_diagram.append("g").append("path")
                    .attr("d", line(data5))
                    .style("stroke-dasharray", ("20, 5, 2, 5"))
                    .style("stroke", E_color)
                    .style("stroke-width", 2);

                    svg_diagram.append("g").append("path")
                    .attr("d", line(data6))
                    .style("stroke-dasharray", ("20, 5, 2, 5, 2, 5"))
                    .style("stroke", E_color)
                    .style("stroke-width", 2);

                    svg_diagram.append("g").append("path")
                    .attr("d", line(data7))
                    .style("stroke-dasharray", ("3, 3"))
                    .style("stroke", R_color)
                    .style("stroke-width", 2);

                    svg_diagram.append("g").append("path")
                    .attr("d", line(data8))
                    .style("stroke-dasharray", ("0, 0"))
                    .style("stroke", S_color)
                    .style("stroke-width", 2);
                }

                // Подписи

                svg_diagram.append("g").append("text")
                    .attr("x", width - margin + 30)
                    .attr("y", height - margin - 14)
                    .attr("text-anchor", "end")
                    .style("font-size", "13px")
                    .text("Дискретное");

                svg_diagram.append("g").append("text")
                    .attr("x", width - margin + 30)
                    .attr("y", height - margin - 5)
                    .attr("text-anchor", "end")
                    .style("font-size", "13px")
                    .text("время");

                // Стрелки
                // define arrow markers for graph links
                svg_diagram.append('svg:defs').append('svg:marker')
                    .attr('id', 'end-arrow')
                    .attr('viewBox', '0 -5 10 10')
                    .attr('refX', 15) //сдвиг
                    .attr('markerWidth', 4) //размер
                    .attr('markerHeight', 6) //размер
                    .attr('orient', 'auto')
                  .append('svg:path')
                    .attr('d', 'M0,-5L10,0L0,5')
                    .attr('fill', '#000')
                    .style("stroke", "grey");

/////////////////////////////////////////////////////////////////////////////
                //8 букв - подписей
                //  if (!isRiskAndChance) {
                if (!isRiskAndChance) {
                    var part = Math.floor(save_num_steps / 8);

                    if (mas_length > (part - 1)) {
                        svg_diagram.append("g").append("text")
                            .attr("x", data8[part - 1].x + 42)
                            .attr("y", data8[part - 1].y - 32) // - margin - 15)
                            .attr("text-anchor", "end")
                            .style("font-size", "14px")
                            .text("S");

                        svg_diagram.append("line")
                            .attr("x1", data8[part - 1].x + 30)
                            .attr("y1", data8[part - 1].y - 30)
                            .attr("x2", data8[part - 1].x)
                            .attr("y2", data8[part - 1].y)
                            .attr("class", "link")
                            .style('marker-end', 'url(#end-arrow)')
                            .style("stroke-width", 1.5);
                    }
                    if (mas_length > (part * 2 - 1)) {
                        svg_diagram.append("g").append("text")
                            .attr("x", data1[part * 2 - 1].x + 42)
                            .attr("y", data1[part * 2 - 1].y - 32) // - margin - 15)
                            .attr("text-anchor", "end")
                            .style("font-size", "14px")
                            .text("I1");

                        svg_diagram.append("line")
                            .attr("x1", data1[part * 2 - 1].x + 30)
                            .attr("y1", data1[part * 2 - 1].y - 30)
                            .attr("x2", data1[part * 2 - 1].x)
                            .attr("y2", data1[part * 2 - 1].y)
                            .attr("class", "link")
                            .style('marker-end', 'url(#end-arrow)')
                            .style("stroke-width", 1.5);
                    }
                    if (mas_length > (part * 3 - 1)) {
                        svg_diagram.append("g").append("text")
                            .attr("x", data2[part * 3 - 1].x + 46)
                            .attr("y", data2[part * 3 - 1].y - 32) // - margin - 15)
                            .attr("text-anchor", "end")
                            .style("font-size", "14px")
                            .text("I2");

                        svg_diagram.append("line")
                            .attr("x1", data2[part * 3 - 1].x + 30)
                            .attr("y1", data2[part * 3 - 1].y - 30)
                            .attr("x2", data2[part * 3 - 1].x)
                            .attr("y2", data2[part * 3 - 1].y)
                            .attr("class", "link")
                            .style('marker-end', 'url(#end-arrow)')
                            .style("stroke-width", 1.5);
                    }
                    if (mas_length > part * 4 - 1) {
                        svg_diagram.append("g").append("text")
                            .attr("x", data3[part * 4 - 1].x + 42)
                            .attr("y", data3[part * 4 - 1].y - 32) // - margin - 15)
                            .attr("text-anchor", "end")
                            .style("font-size", "14px")
                            .text("A+M1");

                        svg_diagram.append("line")
                            .attr("x1", data3[part * 4 - 1].x + 30)
                            .attr("y1", data3[part * 4 - 1].y - 30)
                            .attr("x2", data3[part * 4 - 1].x)
                            .attr("y2", data3[part * 4 - 1].y)
                            .attr("class", "link")
                            .style('marker-end', 'url(#end-arrow)')
                            .style("stroke-width", 1.5);
                    }
                    if (mas_length > part * 5 - 1) {
                        svg_diagram.append("g").append("text")
                            .attr("x", data4[part * 5 - 1].x + 42)
                            .attr("y", data4[part * 5 - 1].y - 32) // - margin - 15)
                            .attr("text-anchor", "end")
                            .style("font-size", "14px")
                            .text("A+M2");

                        svg_diagram.append("line")
                            .attr("x1", data4[part * 5 - 1].x + 30)
                            .attr("y1", data4[part * 5 - 1].y - 30)
                            .attr("x2", data4[part * 5 - 1].x)
                            .attr("y2", data4[part * 5 - 1].y)
                            .attr("class", "link")
                            .style('marker-end', 'url(#end-arrow)')
                            .style("stroke-width", 1.5);
                    }
                    if (mas_length > part * 6 - 1) {
                        svg_diagram.append("g").append("text")
                            .attr("x", data5[part * 6 - 1].x + 42)
                            .attr("y", data5[part * 6 - 1].y - 32) // - margin - 15)
                            .attr("text-anchor", "end")
                            .style("font-size", "14px")
                            .text("E1");

                        svg_diagram.append("line")
                            .attr("x1", data5[part * 6 - 1].x + 30)
                            .attr("y1", data5[part * 6 - 1].y - 30)
                            .attr("x2", data5[part * 6 - 1].x)
                            .attr("y2", data5[part * 6 - 1].y)
                            .attr("class", "link")
                            .style('marker-end', 'url(#end-arrow)')
                            .style("stroke-width", 1.5);
                    }
                    if (mas_length > part * 7 - 1) {
                        svg_diagram.append("g").append("text")
                            .attr("x", data6[part * 7 - 1].x + 42)
                            .attr("y", data6[part * 7 - 1].y - 32) // - margin - 15)
                            .attr("text-anchor", "end")
                            .style("font-size", "14px")
                            .text("E2");

                        svg_diagram.append("line")
                            .attr("x1", data6[part * 7 - 1].x + 30)
                            .attr("y1", data6[part * 7 - 1].y - 30)
                            .attr("x2", data6[part * 7 - 1].x)
                            .attr("y2", data6[part * 7 - 1].y)
                            .attr("class", "link")
                            .style('marker-end', 'url(#end-arrow)')
                            .style("stroke-width", 1.5);
                    }
                    if (mas_length > part * 8 - 1) {
                        svg_diagram.append("g").append("text")
                            .attr("x", data7[part * 8 - 1].x + 42)
                            .attr("y", data7[part * 8 - 1].y - 32) // - margin - 15)
                            .attr("text-anchor", "end")
                            .style("font-size", "14px")
                            .text("R");

                        svg_diagram.append("line")
                            .attr("x1", data7[part * 8 - 1].x + 30)
                            .attr("y1", data7[part * 8 - 1].y - 30)
                            .attr("x2", data7[part * 8 - 1].x)
                            .attr("y2", data7[part * 8 - 1].y)
                            .attr("class", "link")
                            .style('marker-end', 'url(#end-arrow)')
                            .style("stroke-width", 1.5);
                    }
                } else {
                    var part = Math.floor(save_num_steps / 4);

                    if (mas_length > (part - 1)) {
                        svg_diagram.append("g").append("text")
                            .attr("x", data1[part - 1].x + 42)
                            .attr("y", data1[part - 1].y - 32) // - margin - 15)
                            .attr("text-anchor", "end")
                            .style("font-size", "14px")
                            .text(function () {
                                if (selectedGraphicType == 2) return "Т2";
                                else return "Т1";
                            });

                        svg_diagram.append("line")
                            .attr("x1", data1[part - 1].x + 30)
                            .attr("y1", data1[part - 1].y - 30)
                            .attr("x2", data1[part - 1].x)
                            .attr("y2", data1[part - 1].y)
                            .attr("class", "link")
                            .style('marker-end', 'url(#end-arrow)')
                            .style("stroke-width", 1.5);
                    }
                    if (mas_length > (part * 2 - 1)) {
                        svg_diagram.append("g").append("text")
                            .attr("x", data2[part * 2 - 1].x + 42)
                            .attr("y", data2[part * 2 - 1].y - 32) // - margin - 15)
                            .attr("text-anchor", "end")
                            .style("font-size", "14px")
                            .text(function () {
                                if (selectedGraphicType == 2) return "Т1";
                                else return "Т2";
                            });

                        svg_diagram.append("line")
                            .attr("x1", data2[part * 2 - 1].x + 30)
                            .attr("y1", data2[part * 2 - 1].y - 30)
                            .attr("x2", data2[part * 2 - 1].x)
                            .attr("y2", data2[part * 2 - 1].y)
                            .attr("class", "link")
                            .style('marker-end', 'url(#end-arrow)')
                            .style("stroke-width", 1.5);
                    }
/*                    if (mas_length > (part * 3 - 1)) {
                        svg_diagram.append("g").append("text")
                            .attr("x", data3[part * 3 - 1].x + 46)
                            .attr("y", data3[part * 3 - 1].y - 32) // - margin - 15)
                            .attr("text-anchor", "end")
                            .style("font-size", "14px")
                            .text(function () {
                                if (selectedGraphicType == 2) return "Т12";
                                else return "Т21";
                            });

                        svg_diagram.append("line")
                            .attr("x1", data3[part * 3 - 1].x + 30)
                            .attr("y1", data3[part * 3 - 1].y - 30)
                            .attr("x2", data3[part * 3 - 1].x)
                            .attr("y2", data3[part * 3 - 1].y)
                            .attr("class", "link")
                            .style('marker-end', 'url(#end-arrow)')
                            .style("stroke-width", 1.5);
                    }
                    if (mas_length > part * 4 - 1) {
                        svg_diagram.append("g").append("text")
                            .attr("x", data4[part * 4 - 1].x + 42)
                            .attr("y", data4[part * 4 - 1].y - 32) // - margin - 15)
                            .attr("text-anchor", "end")
                            .style("font-size", "14px")
                            .text(function () {
                                if (selectedGraphicType == 2) return "Т21";
                                else return "Т12";
                            });

                        svg_diagram.append("line")
                            .attr("x1", data4[part * 4 - 1].x + 30)
                            .attr("y1", data4[part * 4 - 1].y - 30)
                            .attr("x2", data4[part * 4 - 1].x)
                            .attr("y2", data4[part * 4 - 1].y)
                            .attr("class", "link")
                            .style('marker-end', 'url(#end-arrow)')
                            .style("stroke-width", 1.5);
                    }*/
                }
/////////////////////////////////////////////////////////////////////////////

                //Добавляем легенду
                var strokes = 8;

                var data_legend = [];
                if (!isRiskAndChance) {
                    data_legend = [
                            { "status": "Infected1", "color": I_color },
                            { "status": "Infected2", "color": I_color },
                            { "status": "Admined+Immunate1", "color": AM_color },
                            { "status": "Admined+Immunate2", "color": AM_color },
                            { "status": "Latent1", "color": E_color },
                            { "status": "Latent2", "color": E_color },
                            { "status": "Removed", "color": R_color },
                            { "status": "Susceptible", "color": S_color }
                    ];
                } else {
                    strokes = 2;
                    data_legend = [];
                    if (selectedGraphicType == 2) {
                        data_legend.push({ "status": "Тема" + (parseInt(selected_tem1) + 1), "color": I_color });
                        data_legend.push({ "status": "Тема" + (parseInt(selected_tem2) + 1), "color": I_color });
                //        data_legend.push({ "status": "Тема" + 12, "color": AM_color });
                //        data_legend.push({ "status": "Тема" + 21, "color": AM_color });
                    } else {
                        data_legend.push({ "status": "Тема" + (parseInt(selected_tem2) + 1), "color": I_color });
                        data_legend.push({ "status": "Тема" + (parseInt(selected_tem1) + 1), "color": I_color });
              //          data_legend.push({ "status": "Тема" + 21, "color": AM_color });
              //          data_legend.push({ "status": "Тема" + 12, "color": AM_color });
                    }
                }

                    for (var i = 0; i < strokes; i++) {
                    //Draw the text
                    svg_diagram.append("g").append("text")
                                    .attr("x", width - 110)
                                    .attr("y", 8 + i * 11 + 10) //i * 11
                                    .text(data_legend[i].status)
                                    .attr("font-size", "14px");

                    //Draw the lines
                    svg_diagram.append("g").append("line")
                                             .attr("x1", width - 185)
                                             .attr("y1", i * 11 + 5 + 10)
                                             .attr("x2", width - 128 + 10)
                                             .attr("y2", i * 11 + 5 + 10)
                                             .style("stroke", function (d) { return data_legend[i].color; })
                                             .style("stroke-dasharray", function (d) {
                                                 if (i == 0) return ("7, 5, 2, 5");
                                                 else if (i == 1) return ("7, 5, 2, 5, 2, 5");
                                                 else if (i == 2) return ("20, 5, 5, 5");
                                                 else if (i == 3) return ("20, 5, 5, 5, 5, 5");
                                                 else if (i == 4) return ("20, 5, 2, 5");
                                                 else if (i == 5) return ("20, 5, 2, 5, 2, 5");
                                                 else if (i == 6) return ("3, 3");
                                                 else return ("0, 0");
                                             });
                }
            }

            // Добавим 2 прямоугольника выбора инфекции
            this.addInfectionRects = function (data) {

                var jsonRects = [
                        { "rectId": 0, "rectNum": 0, "lable": "Infected1", "x_axis": 10, "y_axis": 10, "width": 25, "height": 25, "color": "#428bca" },
                        { "rectId": 1, "rectNum": 1, "lable": "Infected2", "x_axis": 50, "y_axis": 10, "width": 25, "height": 25, "color": "Orange" }
            ];

            var rects = containerRects.selectAll("rect")
                                      .data(jsonRects)
                                      .enter()
                                      .append("rect")
                                      .on("mousedown", function (d) { return choseStatusNode(d); });

            rects.append("title").text(function (d) { return "Лэйбл:" + d.lable; });

            var rectAttributes = rects
            .attr("x", function (d) { return d.x_axis; })
            .attr("y", function (d) { return d.y_axis; })
            .attr("width", 25)
            .attr("height", 25)
            .style("fill", function (d) { return d.color; });

            //Draw the text
                containerRects.append("text")
                                   .attr("x", 17)
                                   .attr("y", 27) //i * 11
                                   .text("I1")
                                   .attr("font-size", "14px")
                                   .attr("fill", "White")
                                   .on("mousedown", function (d) { return choseStatusNode(jsonRects[0]); });

                containerRects.append("text")
                   .attr("x", 57)
                   .attr("y", 27) //i * 11
                   .text("I2")
                   .attr("font-size", "14px")
                   .attr("fill", "White")
                   .on("mousedown", function (d) { return choseStatusNode(jsonRects[1]); });
            }

            // Удалим 2 прямоугольника выбора инфекции
            this.deleteInfectionRects = function (data) {
                containerRects.selectAll("text").remove();
                containerRects.selectAll("rect").remove();
            }

            // Функция обновления сети/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
            this.refreshEpidemiGraph = function (data) {

                // Очистим использованные стартовые вершины
                TemsObjects[selected_tematic].Selected = [];
                tematic_changed = false;
                isFirstStepEpidemi = false;

                // Для двойной модели
                TemsObjectsTwo[0].Selected1 = [];
                TemsObjectsTwo[0].Selected2 = [];

                var self = this;

                // Очистим от старого графа
                container.selectAll(".link").remove();
                container.selectAll(".node").remove();
//                container.selectAll("text").remove();

                var link = container.selectAll(".link")
                                                .data(data.links)
                                                .enter().append("line")
                                                .attr("class", "link")
                                                //.style('marker-start', function (d) { return 'url(#start-arrow)' })
                                                //.style('marker-end', function (d) { return d.right ? 'url(#end-arrow)' : ''; })
                                                .style("stroke-width", function (d) { return self.link_weight - 0 });

                var node = container.selectAll(".node")
                                .data(data.nodes)
                                .enter().append("circle")
                                .attr("class", "node")
                                .attr("r", function (d) { return self.node_radius - 0 })
                                .style("fill", function (d) { return d.color })
                                .on("mousedown", function (d) { return _this.addColor(d); });

                // Подписываем узлы
                node.append("title").text(function (d) { return "Номер: " + d.nodeId + " Соседей: " + d.weight + " Вес: " + d.nodeWeight + " Слой: " + d.layer + " Статус: " + d.status; });

                //значения объектов поместили в контейнер
                link.attr("x1", function (d) { return d.x_source; })
                        .attr("y1", function (d) { return d.y_source; })
                        .attr("x2", function (d) { return d.x_target; })
                        .attr("y2", function (d) { return d.y_target; });

                node.attr("cx", function (d) { return d.x_coordinate; })
                        .attr("cy", function (d) { return d.y_coordinate; });

                //Add the SVG Text Element to the svgContainer

                var text = container.selectAll(".text")
                                        .data(data.nodes)
                                        .enter()
                                        .append("text");

                var text2 = container.selectAll(".text")
                            .data(data.nodes)
                            .enter()
                            .append("text");
                //Буквы
                var textLabels2 = text2
                                 .attr("x", function (d) {
                                     if (d.letter == "I") return d.x_coordinate - 1;
                                     if (d.letter == "A+M") return d.x_coordinate - 6.5;
                                     if (d.letter == "E") return d.x_coordinate - 3;
                                     if (d.letter == "S") return d.x_coordinate - 3;
                                     if (d.letter == "R") return d.x_coordinate - 3;
                                     if (d.letter == "I1") return d.x_coordinate - 3;
                                     if (d.letter == "A+M1") return d.x_coordinate - 6.5;
                                     if (d.letter == "E1") return d.x_coordinate - 5;
                                     if (d.letter == "I2") return d.x_coordinate - 3;
                                     if (d.letter == "A+M2") return d.x_coordinate - 6.5;
                                     if (d.letter == "E2") return d.x_coordinate - 5;
                                 })
                                 .attr("y", function (d) { return d.y_coordinate + 3; })
                                 .text(function (d) { return d.letter; })
                                 .attr("font-family", "sans-serif")
                                 .attr("font-size", function (d) {
                                     if (d.letter == "A+M") return "6px";
                                     if (d.letter == "A+M1") return "5px";
                                     if (d.letter == "A+M2") return "5px";
                                     return "8px";})
                                 .attr("fill", function (d) {
                                     if (d.letter == "I") return I_letter_color;
                                     if (d.letter == "A+M") return AM_letter_color;
                                     if (d.letter == "E") return E_letter_color;
                                     if (d.letter == "S") return S_letter_color;
                                     if (d.letter == "R") return R_letter_color;
                                     if (d.letter == "I1") return I_letter_color;
                                     if (d.letter == "A+M1") return AM_letter_color;
                                     if (d.letter == "E1") return E_letter_color;
                                     if (d.letter == "I2") return I_letter_color;
                                     if (d.letter == "A+M2") return AM_letter_color;
                                     if (d.letter == "E2") return E_letter_color;
                                 })

                // Заполняем данными для графа
                if (this.isTwoModel == false) {
                    TemsObjects[selected_tematic].Nodes.Infected.push(data["epidemi"]["i_count"]);
                    TemsObjects[selected_tematic].Nodes.Protected.push(data["epidemi"]["am_count"]);
                    TemsObjects[selected_tematic].Nodes.Latent.push(data["epidemi"]["e_count"]);
                    TemsObjects[selected_tematic].Nodes.Died.push(data["epidemi"]["r_count"]);
                    TemsObjects[selected_tematic].Nodes.Susceptible.push(data["epidemi"]["s_count"]);

                    TemsObjects[selected_tematic].dNodes.Infected.push(data["epidemi"]["di_count"]);
                    TemsObjects[selected_tematic].dNodes.Protected.push(data["epidemi"]["dam_count"]);
                    TemsObjects[selected_tematic].dNodes.Latent.push(data["epidemi"]["de_count"]);
                    TemsObjects[selected_tematic].dNodes.Died.push(data["epidemi"]["dr_count"]);
                    TemsObjects[selected_tematic].dNodes.Susceptible.push(data["epidemi"]["ds_count"]);

                    TemsObjects[selected_tematic].Traffic.Infected.push(data["epidemi"]["risk_i"]);
                    TemsObjects[selected_tematic].Traffic.Protected.push(data["epidemi"]["risk_am"]);
                    TemsObjects[selected_tematic].Traffic.Latent.push(data["epidemi"]["risk_e"]);
                    TemsObjects[selected_tematic].Traffic.Died.push(data["epidemi"]["risk_r"]);
                    TemsObjects[selected_tematic].Traffic.Susceptible.push(data["epidemi"]["risk_s"]);

                    TemsObjects[selected_tematic].dTraffic.Infected.push(data["epidemi"]["drisk_i"]);
                    TemsObjects[selected_tematic].dTraffic.Protected.push(data["epidemi"]["drisk_am"]);
                    TemsObjects[selected_tematic].dTraffic.Latent.push(data["epidemi"]["drisk_e"]);
                    TemsObjects[selected_tematic].dTraffic.Died.push(data["epidemi"]["drisk_r"]);
                    TemsObjects[selected_tematic].dTraffic.Susceptible.push(data["epidemi"]["drisk_s"]);
                }
                else {
                    TemsObjectsTwo[0].Nodes.Infected1.push(data["epidemi"]["i1_count"]);
                    TemsObjectsTwo[0].Nodes.Infected2.push(data["epidemi"]["i2_count"]);
                    TemsObjectsTwo[0].Nodes.Protected1.push(data["epidemi"]["am1_count"]);
                    TemsObjectsTwo[0].Nodes.Protected2.push(data["epidemi"]["am2_count"]);
                    TemsObjectsTwo[0].Nodes.Latent1.push(data["epidemi"]["e1_count"]);
                    TemsObjectsTwo[0].Nodes.Latent2.push(data["epidemi"]["e2_count"]);
                    TemsObjectsTwo[0].Nodes.Died.push(data["epidemi"]["r_count"]);
                    TemsObjectsTwo[0].Nodes.Susceptible.push(data["epidemi"]["s_count"]);

                    TemsObjectsTwo[0].dNodes.Infected1.push(data["epidemi"]["di1_count"]);
                    TemsObjectsTwo[0].dNodes.Infected2.push(data["epidemi"]["di2_count"]);
                    TemsObjectsTwo[0].dNodes.Protected1.push(data["epidemi"]["dam1_count"]);
                    TemsObjectsTwo[0].dNodes.Protected2.push(data["epidemi"]["dam2_count"]);
                    TemsObjectsTwo[0].dNodes.Latent1.push(data["epidemi"]["de1_count"]);
                    TemsObjectsTwo[0].dNodes.Latent2.push(data["epidemi"]["de2_count"]);
                    TemsObjectsTwo[0].dNodes.Died.push(data["epidemi"]["dr_count"]);
                    TemsObjectsTwo[0].dNodes.Susceptible.push(data["epidemi"]["ds_count"]);

                    TemsObjectsTwo[0].Traffic.Infected1.push(data["epidemi"]["risk_i1"]);
                    TemsObjectsTwo[0].Traffic.Infected2.push(data["epidemi"]["risk_i2"]);
                    TemsObjectsTwo[0].Traffic.Protected1.push(data["epidemi"]["risk_am1"]);
                    TemsObjectsTwo[0].Traffic.Protected2.push(data["epidemi"]["risk_am2"]);
                    TemsObjectsTwo[0].Traffic.Latent1.push(data["epidemi"]["risk_e1"]);
                    TemsObjectsTwo[0].Traffic.Latent2.push(data["epidemi"]["risk_e2"]);
                    TemsObjectsTwo[0].Traffic.Died.push(data["epidemi"]["risk_r"]);
                    TemsObjectsTwo[0].Traffic.Susceptible.push(data["epidemi"]["risk_s"]);

                    TemsObjectsTwo[0].dTraffic.Infected1.push(data["epidemi"]["drisk_i1"]);
                    TemsObjectsTwo[0].dTraffic.Infected2.push(data["epidemi"]["drisk_i2"]);
                    TemsObjectsTwo[0].dTraffic.Protected1.push(data["epidemi"]["drisk_am1"]);
                    TemsObjectsTwo[0].dTraffic.Protected2.push(data["epidemi"]["drisk_am2"]);
                    TemsObjectsTwo[0].dTraffic.Latent1.push(data["epidemi"]["drisk_e1"]);
                    TemsObjectsTwo[0].dTraffic.Latent2.push(data["epidemi"]["drisk_e2"]);
                    TemsObjectsTwo[0].dTraffic.Died.push(data["epidemi"]["drisk_r"]);
                    TemsObjectsTwo[0].dTraffic.Susceptible.push(data["epidemi"]["drisk_s"]);

//                   document.write(data["epidemi"]["risk_s"] + ' = ');
//                   document.write(TemsObjectsTwo[0].Risk.Susceptible[5]);
                }
                //
//                document.write(TemsObjects[selected_tematic].Nodes.Infected[0]);

//                if (this.isTwoModel == false) _this.drawDiagram();
//                else _this.drawDiagramTwo();

                //Рекурсия
                if(!pauseepidemiFlag){
                    if (save_num_steps_recurce != 0) {
                        save_num_steps_recurce--;
                        setTimeout(function () { _this.startepidemi(); }, wait_time);
                    }
                    else {
                        _this.finishepidemi();   // Очистим флаги и неработающие менюшки после эпидемии
                    }

                    var prc = save_num_steps - save_num_steps_recurce;
                    // Progress
                    $('#epidemic_progress').attr('aria-valuenow', prc);
                    $('#epidemic_progress').css('width', (prc / save_num_steps) * 100 + '%'); //prc + '%'
                    $('#epidemic_progress').text(prc + ' шаг'); //prc + '%'
                }
            }

//////////////////////
            //Мой обработчик кнопки "Начать эпидемию"
            this.startepidemi = function () {

                // Массивы - здесь нужно отослать помеченные стартовые вершины
                var str_first_infected = TemsObjects[selected_tematic].Selected.toString();

                // Для двойной модели
                var str_first_infected1 = TemsObjectsTwo[0].Selected1.toString();
                var str_first_infected2 = TemsObjectsTwo[0].Selected2.toString();

                var select = selected_tematic;
                var select2 = selected_tematic;
                //
                if (networkGraph.isTwoModel) {
                    select = selected_tem1;
                    select2 = selected_tem2;
                }

                var p_i1 = masMicrofractalP[select][0];
                var p_r1 = masMicrofractalP[select][1];
                var p_e1 = masMicrofractalP[select][2];
                var p_am1 = masMicrofractalP[select][3];

                var p_i2 = masMicrofractalP[select2][0];
                var p_r2 = masMicrofractalP[select2][1];
                var p_e2 = masMicrofractalP[select2][2];
                var p_am2 = masMicrofractalP[select2][3];

                $.ajax({
                    url: '/Main/EpidemiBuilder'
                      , type: 'POST'
                      , dataType: "json"
                      , data: { str_infected1: str_first_infected1, str_infected2: str_first_infected2, pam1: p_am1, pe1: p_e1, pi1: p_i1, pr1: p_r1, pam2: p_am2, pe2: p_e2, pi2: p_i2, pr2: p_r2, isTwiceModel: networkGraph.isTwoModel, isFirstStep: isFirstStepEpidemi, coeff_ofreposts: coeff_reposts, was_changed_tematic: tematic_changed, selected_tematic: selected_tematic, lines_micro: lines_microfractal, str_infected: str_first_infected, num_nodes: save_num_nodes, name_layout: save_name_layout, name_overlap: save_name_overlap, name_random: $("#name_random option:selected").val() }
                      , success: function (data) {
                          if (data.success) {
                              //var data_tmp = $.extend(true,{}, data);
                              //console.debug(data_tmp);

                              _this.refreshEpidemiGraph(data);
                          }
                      }
                });
            }

//Мой обработчик кнопки "В реальном времени"
            this.inRealTime = function () {
                // Делаем лишние кнопки неактивными
//                var li_left_menu = $('.control-main li'); //control - nav

//                <button type="button" class="btn btn-default btn-lg" disabled="disabled">Default</button>

 //               li_left_menu.eq(0).addClass("disabled").find("a").attr("onclick", "return false;");

//                disabledMenuFlag = true;
                stopepidemiFlag = false;

                isOnlyTems = false;

                if (!pauseepidemiFlag) {

                    isFirstStepEpidemi = true;

                    //Очистим граф
//                    svg_diagram.selectAll("line").remove();
                    svg_diagram.selectAll("text").remove();
//                    this.was_critical = false;

                    // Очистим тему
                    if (networkGraph.isTwoModel == false) {
                        TemsObjects[selected_tematic].Traffic.Infected = [];
                        TemsObjects[selected_tematic].Traffic.Protected = [];
                        TemsObjects[selected_tematic].Traffic.Latent = [];
                        TemsObjects[selected_tematic].Traffic.Died = [];
                        TemsObjects[selected_tematic].Traffic.Susceptible = [];

                        TemsObjects[selected_tematic].dTraffic.Infected = [];
                        TemsObjects[selected_tematic].dTraffic.Protected = [];
                        TemsObjects[selected_tematic].dTraffic.Latent = [];
                        TemsObjects[selected_tematic].dTraffic.Died = [];
                        TemsObjects[selected_tematic].dTraffic.Susceptible = [];

                        TemsObjects[selected_tematic].Nodes.Infected = [];
                        TemsObjects[selected_tematic].Nodes.Protected = [];
                        TemsObjects[selected_tematic].Nodes.Latent = [];
                        TemsObjects[selected_tematic].Nodes.Died = [];
                        TemsObjects[selected_tematic].Nodes.Susceptible = [];

                        TemsObjects[selected_tematic].dNodes.Infected = [];
                        TemsObjects[selected_tematic].dNodes.Protected = [];
                        TemsObjects[selected_tematic].dNodes.Latent = [];
                        TemsObjects[selected_tematic].dNodes.Died = [];
                        TemsObjects[selected_tematic].dNodes.Susceptible = [];

                        TemsObjects[selected_tematic].Risk = [];
                        TemsObjects[selected_tematic].dRisk = [];
                        TemsObjects[selected_tematic].Chance = [];
                        TemsObjects[selected_tematic].dChance = [];
                    }
                    else {
                        TemsObjectsTwo[0].Traffic.Infected1 = [];
                        TemsObjectsTwo[0].Traffic.Infected2 = [];
                        TemsObjectsTwo[0].Traffic.Protected1 = [];
                        TemsObjectsTwo[0].Traffic.Protected2 = [];
                        TemsObjectsTwo[0].Traffic.Latent1 = [];
                        TemsObjectsTwo[0].Traffic.Latent2 = [];
                        TemsObjectsTwo[0].Traffic.Died = [];
                        TemsObjectsTwo[0].Traffic.Susceptible = [];

                        TemsObjectsTwo[0].Nodes.Infected1 = [];
                        TemsObjectsTwo[0].Nodes.Infected2 = [];
                        TemsObjectsTwo[0].Nodes.Protected1 = [];
                        TemsObjectsTwo[0].Nodes.Protected2 = [];
                        TemsObjectsTwo[0].Nodes.Latent1 = [];
                        TemsObjectsTwo[0].Nodes.Latent2 = [];
                        TemsObjectsTwo[0].Nodes.Died = [];
                        TemsObjectsTwo[0].Nodes.Susceptible = [];

                        TemsObjectsTwo[0].dTraffic.Infected1 = [];
                        TemsObjectsTwo[0].dTraffic.Infected2 = [];
                        TemsObjectsTwo[0].dTraffic.Protected1 = [];
                        TemsObjectsTwo[0].dTraffic.Protected2 = [];
                        TemsObjectsTwo[0].dTraffic.Latent1 = [];
                        TemsObjectsTwo[0].dTraffic.Latent2 = [];
                        TemsObjectsTwo[0].dTraffic.Died = [];
                        TemsObjectsTwo[0].dTraffic.Susceptible = [];

                        TemsObjectsTwo[0].dNodes.Infected1 = [];
                        TemsObjectsTwo[0].dNodes.Infected2 = [];
                        TemsObjectsTwo[0].dNodes.Protected1 = [];
                        TemsObjectsTwo[0].dNodes.Protected2 = [];
                        TemsObjectsTwo[0].dNodes.Latent1 = [];
                        TemsObjectsTwo[0].dNodes.Latent2 = [];
                        TemsObjectsTwo[0].dNodes.Died = [];
                        TemsObjectsTwo[0].dNodes.Susceptible = [];

                        TemsObjectsTwo[0].Risk1 = [];
                        TemsObjectsTwo[0].Risk2 = [];
                        TemsObjectsTwo[0].dRisk1 = [];
                        TemsObjectsTwo[0].dRisk2 = [];

                        TemsObjectsTwo[0].Chance1 = [];
                        TemsObjectsTwo[0].Chance2 = [];
                        TemsObjectsTwo[0].dChance1 = [];
                        TemsObjectsTwo[0].dChance2 = [];

                        TemsObjectsTwo[0].Risk12 = [];
                        TemsObjectsTwo[0].Risk21 = [];
                        TemsObjectsTwo[0].dRisk12 = [];
                        TemsObjectsTwo[0].dRisk21 = [];

                        TemsObjectsTwo[0].Chance12 = [];
                        TemsObjectsTwo[0].Chance21 = [];
                        TemsObjectsTwo[0].dChance12 = [];
                        TemsObjectsTwo[0].dChance21 = [];
                    }

                    save_num_steps_recurce = save_num_steps;
                }
                else save_num_steps_recurce--;

                pauseepidemiFlag = false;
                // Рекурсия
                setTimeout(function () { _this.startepidemi(); }, wait_time);
//                ui.nav.click(3);
            }

            //Мой обработчик кнопки "Пауза эпидемии"
            this.pauseepidemi = function () {
                pauseepidemiFlag = true;
            }

            //Мой обработчик кнопки "Конец эпидемии"
            this.finishepidemi = function () { // Очистим флаги и неработающие менюшки после эпидемии

                // Посчитаем риски и шансы у собранного массива
                if (networkGraph.isTwoModel == false) {
                    TemsObjects[selected_tematic].makeRiskAndChance();
                } else {
                    TemsObjectsTwo[0].makeRiskAndChance();
                }

 //               disabledMenuFlag = false;

//                var li_left_menu = $('.control-main li'); //control - nav

//                li_left_menu.eq(0).removeClass("disabled").find("a").attr("onclick", "ui.nav.click(3)");

//                ui.nav.click(ui_nav_save);
            }

            //Мой обработчик кнопки "Остановить эпидемию"
            this.stopepidemi = function () {
                save_num_steps_recurce = 0;
                stopepidemiFlag = true;

//                ui.nav.click(ui_nav_save);
            }

            //Мой обработчик кнопки "Очистить эпидемию"
            this.clearepidemi = function () {
                pauseepidemiFlag = false;
                stopepidemiFlag = false;

                this.isLayeredDisplay = false;
                this.isLayeredDisplayCut = false;

                $.ajax({
                    url: '/Main/СlearEpidemi'
                    ,type: 'POST'
                    ,dataType: "json"
                    , data: { isTwiceModel: networkGraph.isTwoModel, selected_tematic: selected_tematic }
                    ,success: function (data) {
                        if (data.success) {
                            //_this.makeReLay(0);
                            _this.refreshNet(data);
                            tematic_changed = false;
                        }
                    }
                });
            }

            //Мой обработчик кнопки "Сменить граф"
            this.changeGraph = function () {
                pauseepidemiFlag = false;
                stopepidemiFlag = false;

                this.isLayeredDisplay = false;
                this.isLayeredDisplayCut = false;

                $.ajax({
                    url: '/Main/ChangeGraph'
                    ,type: 'POST'
                    ,dataType: "json"
                    ,data: { isTwiceModel: networkGraph.isTwoModel, selected_tematic: selected_tematic }
                    ,success: function (data) {
                        if (data.success) {
                            _this.refreshNet(data);
                            tematic_changed = false;
                        }
                    }
                });
            }

            //Мой обработчик кнопки "Обновить укладку и послойная модель"
            this.makeReLay = function (data) {

                // Массивы - здесь нужно отослать помеченные стартовые вершины
                var str_first_infected = TemsObjects[selected_tematic].Selected.toString();

                // Для двойной модели
                var str_first_infected1 = TemsObjectsTwo[0].Selected1.toString();
                var str_first_infected2 = TemsObjectsTwo[0].Selected2.toString();

                var name_lay = $("#name_layout option:selected").val();
                if (data == 1) {
                    name_lay = "layered";
                }
                else {
                    this.isLayeredDisplay = false;
                    this.isLayeredDisplayCut = false;
                }

                $.ajax({
                    url: '/Main/MakeReLay'
                      , type: 'POST'
                      , dataType: "json"
                      , data: { isTwiceModel: networkGraph.isTwoModel, str_infected1: str_first_infected1, str_infected2: str_first_infected2, selected_tematic: selected_tematic, isWhiteBlackNeed: this.isWBNeed, isWhiteBlack: this.isWBPrint, isCut: this.isLayeredDisplayCut, str_infected: str_first_infected, dx: this.save_dx, dy: this.save_dy, isLayered: this.isLayeredDisplay, name_layout: name_lay, name_overlap: save_name_overlap }
                      , success: function (data) {
                          if (data.success) {
                              //var data_tmp = $.extend(true,{}, data);
                              //console.debug(data_tmp);
                              _this.isWBNeed = false;
                              _this.refreshNet(data);
                          }
                      }
                });
            }

            //Мой обработчик кнопки "Установить параметры"
            this.setParams = function () {

                var str = $("#name_random option:selected").val();
                var str__random = '';

                if (str == "ErdosRenyi") {
                    str__random =
                    '<div class="input-group">' +
                              '<input type="text" class="form-control" placeholder="" aria-describedby="basic-addon2" value="100" name="random_links" style="width: 200px;">' +
                              '<span class="input-group-addon" id="basic-addon2" style="width: 200px;">Ребер</span>' +
                    '</div>';
                }
                else if (str == "WattsStrogatz") {
                    str__random =
                    '<div class="input-group">' +
                              '<input type="text" class="form-control" placeholder="" aria-describedby="basic-addon2" value="3" name="random_degree" style="width: 200px;">' +
                              '<span class="input-group-addon" id="basic-addon2" style="width: 200px;">Степень ребра</span>' +
                    '</div>';
                }
                else {
                    str__random =
                    '<div class="input-group">' +
                              '<input type="text" class="form-control" placeholder="" aria-describedby="basic-addon2" value="3" name="random_degree" style="width: 200px;">' +
                              '<span class="input-group-addon" id="basic-addon2" style="width: 200px;">Степень ребра</span>' +
                    '</div>';
                }

                document.getElementById('params').innerHTML = str__random;
            }

            //Мой обработчик кнопки "Вывести статистику сети"
            this.netStatistic = function () {

                $.ajax({
                    url: '/Main/NetStatistic',
                    success: function (data) {
                        if (data.success) {
                            num_nodes = data["stats"]["nodes"]; //Текущее количество верши
                            //loop_links = data["stats"]["loops"]; //Текущее количество ребер
                            num_links = data["stats"]["links"]; //Количество петель
                            twisted_links = data["stats"]["twisted"]; //Количество дополнительных дуг
                            unidirectional_links = data["stats"]["unidirectional"]; //Количество только однонаправленных дуг
                            bidirectional_links = data["stats"]["bidirectional"]; //Количество двунаправленных дуг
                            weight_net = data["stats"]["weight"]; //Вес всей сети по ребрам
                        }

                        $('#table_statistics').html(
                             '<br></br>' +
                             '<table class="table table-bordered" style="max-width: 50%;" >' +
                             '<tbody>' +
                              '<tr class="group">' +
                                '<td class="info" style="text-align:center;" colspan="2">Вершины</td>' +
                             '</tr>' +
                             '<tr>' +
                                '<td class="info">Всего</td><td class="info" style="background-color: #ffffff;">' + num_nodes + '</td>' +
                                '</tr>' +
                               '<tr class="group">' +
                             '<td class="info" style="text-align:center;" colspan="2">Рёбра</td>' +
                             '</tr>' +
                                '<tr>' +
                                '<td class="info">Однонаправленные</td><td class="info" style="background-color: #ffffff;">' + unidirectional_links + '</td>' +
                              '</tr>' +
                               '<tr>' +
                             '<td class="info">Двунаправленные</td><td class="info" style="background-color: #ffffff;">' + bidirectional_links + '</td>' +
                                '</tr>' +
                            // '<tr>' +
                            // '<td class="info">Было дублирующих</td><td class="info" style="background-color: #ffffff;">' + twisted_links + '</td>' +
                            // '</tr>' +
                              '<tr>' +
                              '<td class="info">Всего</td><td class="info" style="background-color: #ffffff;">' + num_links + '</td>' +
                              '<tr>' +
                              '<td class="info">Вес сети</td><td class="info" style="background-color: #ffffff;">' + weight_net + '</td>' +
                               '</tr>' +
                                '</table>'
                        ).show();

                        $('#info').html(
                                        '<div class="input-group">' +
                                            '<input type="text" class="form-control" placeholder="" aria-describedby="basic-addon2" value="0,05" name="procent">' +
                                            '<span class="input-group-addon" id="basic-addon2">Точность свёртки (в %)</span>' +
                                            '<span class="input-group-btn"><button class="btn btn-default" type="button" onclick="networkGraph.minimizeNet(); ui.nav.click(3);">Свернуть</button></span>' +
                                        '</div>'
                           ).show();

                    }
                });
            }

            //Мой обработчик кнопки "Свернуть сеть"
            this.minimizeNet = function () {

                $.ajax({
                    url: '/Main/MinimizeNet'
                     , type: 'POST'
                     , dataType: "json"
                     , data: { isLayered: this.isLayeredDisplay, procent: $('input[name=procent]').val() }
                     , success: function (data) {
                         if (data.success) {
                             _this.isLayeredDisplay = false;
                             _this.refreshNet(data);
                         }
                     }
                });
            }

            //Мой обработчик кнопки "Ч/Б"
            this.DoWBPrint = function () {
                this.isWBNeed = true;
                $.ajax({
                    url: '/Main/DoWhiteBlack'
                     , type: 'POST'
                     , dataType: "json"
                     , data: { isWhiteBlack: this.isWBPrint }
                     , success: function (data) {
                         if (data.success) {
                             if (_this.isLayeredDisplay == true)
                                 _this.makeReLay(1);
                            else _this.makeReLay(0);
                         }
                     }
                });
            }

            //Мой обработчик кнопки "Выбрать график одного статуса - Infected или др."
            this.choseOneStatusGraphic = function (data) {
                isOnlyTems = false;
                selected_status = data;
            }

            this.selectGraphicType = function (data) {
                selectedGraphicType = data;

                // Выбираем риски и шансы или вершины и трафик
                if ((selectedGraphicType == 0) || (selectedGraphicType == 1)) isRiskAndChance = false;
                else isRiskAndChance = true;
            }

            //Мой обработчик кнопки "Выбрать микрофрактал" и выбираем микрофрактал другой темы
            this.choseMicrofractal = function (data) {
                isOnlyTems = true;
                selected_tematic = data;
//                tematic_changed = true;
            }

            //Мой обработчик кнопки "Выбрать микрофрактал"
            this.setTematicChanged = function (data) {
               tematic_changed = true;
            }

            //Обработчик кнопки сбросить
            this.reset_force = function () {
                zoom.scale(1);
                zoom.translate([0, 0])
                container.attr("transform", "translate(0,0)scale(1)");
            }

            //checkbox по слоям
            this.toggleLayeredNet = function () {
                if (this.isLayeredDisplay == false) this.isLayeredDisplay = true;
                else this.isLayeredDisplay = false;
            }

            //checkbox по слоям очистить
            this.clearLayeredNet = function () {
                this.isLayeredDisplay = false;
                this.isLayeredDisplayCut = false;
            }

            //checkbox "Урезать слои"
            this.toggleLayeredNetCut = function () {
                if (this.isLayeredDisplayCut == false) this.isLayeredDisplayCut = true;
                else this.isLayeredDisplayCut = false;
            }
            //checkbox "Ч/Б"
            this.toggleWBPrint = function () {
                if (this.isWBPrint == false) {
                    this.isWBPrint = true;
                    // Цвета
                    I_color = "#000000";
                    E_color = "#b4b4b4";
                    R_color = "#4e4e4e";
                    S_color = "#ccc";//"#dedede";
                    AM_color = "#858585";

                    // Цвета букв
                    I_letter_color = "White";
                    E_letter_color = "Black";
                    R_letter_color = "White";
                    S_letter_color = "Black";
                    AM_letter_color = "White";

                    // Доп. цвета
                    Line_color = "#dedede";
                    Infected_color = "#000000";
                }
                else {
                    this.isWBPrint = false;
                    // Цвета
                    I_color = "Black";
                    E_color = "Blue";
                    R_color = "Red";
                    S_color = "Grey";
                    AM_color = "Green";

                    // Цвета букв
                    I_letter_color = "White";
                    E_letter_color = "White";
                    R_letter_color = "White";
                    S_letter_color = "White";
                    AM_letter_color = "White";

                    // Доп. цвета
                    Line_color = "coral";
                    Infected_color = "Orange";
                }
            }

            //checkbox "Одиночная/двойная модель"
            this.toggleOneTwoModel = function () {
                if (this.isTwoModel == false) {
                    this.isTwoModel = true;
                    this.addInfectionRects();
                }
                else {
                    this.isTwoModel = false;
                    this.deleteInfectionRects();
                }
            }

            //checkbox "Вершины/dВершины"
            this.toggleSum = function () {
                if (this.isSetSum == false) {
                    this.isSetSum = true;
                }
                else {
                    this.isSetSum = false;
                }
            }

            //checkbox "Лин/лог масштаб"
            this.toggleLinLogScale = function () {
                if (this.isSetLinScale == false) {
                    this.isSetLinScale = true;
                }
                else {
                    this.isSetLinScale = false;
                }
            }

            return this;
        }
        var networkGraph = new NetworkGraph();

        //все методы создания разметки(визуализации данных)
        var ui = {
            nav: {
                current_index: 0
                , result_current_index: 0
                //отрисовка графиков
                , click_result: function (index) {
        /*            var li = $('#nav_epidemic_result .nav li');
                    li.removeClass(''); //active
                    this.result_current_index = index;
                    li.eq(index).addClass(''); //active*/
                }
                //обработка верхней навигации
                , click: function (index) {
                    var li_left_menu = $('.control-main li'); //control - nav
                    var li_right_menu = $('.control-nav li'); //control - nav
//                    var li_tematic_menu = $('.nav-tabs li'); //control - nav

/*                    li.removeClass(''); //active
                    if (li.eq(index).hasClass('disabled')) {
                        return;
                    }*/

                    this.current_index = index;

                    ui_nav_save = index;

                    li_left_menu.eq(0).removeClass('active');
                    li_left_menu.eq(1).removeClass('active');
                    li_left_menu.eq(2).removeClass('active');

                    li_right_menu.eq(0).removeClass('active');
                    li_right_menu.eq(1).removeClass('active');
                    li_right_menu.eq(2).removeClass('active');
                    li_right_menu.eq(3).removeClass('active');

                    $('#svg_container').hide();
                    $('#svg_container2').hide();
                    $('#svg_container3').hide();

                    $('#info').hide();

                    $('.control-net').hide();
                    $('.control-transition').hide();
                    $('.control-centrality').hide();

                    $('.control-epidemic').hide();
                    $('.control-additional1').hide();
                    $('.control-additional2').hide();
                    $('#control-epidemic-my1').hide();
                    $('#control-epidemic-my2').hide();

                    $('#epidemic_result').hide();
                    $('#podmenu').hide();

                    $('.control-content .content-elements>*').hide();
                    switch (index) {
                        // Подпункт меню "Задать"
                        case 0:
                            //                            li_right_menu.eq(1).addClass('active');
                            //                            li_left_menu.eq(0).addClass('active');

                            var checked = "";
                            if (networkGraph.isLayeredDisplay == true) checked = "checked";

                            var checked3 = "";
                            if (networkGraph.isWBPrint == true) checked3 = "checked";

                            $('#info').html(
                    '<div class="panel panel-default control-main">' +
                    '<div class="panel-heading">Задание случайной сети:</div>' +
                    '<div class="panel-body">' +
                        '<div class="form-group">' +
                           ' <div class="col-sm-12">' +

                        '<div class="input-group">' +
                            '<select class="form-control" id="name_random" name="name_random" style="width: 200px;">' +
                                '<option value="ErdosRenyi">ErdosRenyi</option>' +
                                '<option value="WattsStrogatz">WattsStrogatz</option>' +
                                '<option value="AlbertBarabasi" selected="selected">AlbertBarabasi</option>' +
                            '</select>' +
                            '<span class="input-group-addon" id="basic-addon2" style="width: 100px;">Алгоритм</span>' +
                            '<span class="input-group-btn"><button class="btn btn-default" type="button" onclick="networkGraph.setParams();" style="width: 100px;">Параметры</button></span>' +
                        '</div>' +

                        '<div class="input-group">' +
                            '<input type="text" class="form-control" placeholder="" aria-describedby="basic-addon2" value="' + save_num_nodes + '" name="num_nodes" style="width: 200px;">' +
                            '<span class="input-group-addon" id="basic-addon2" style="width: 100px;">Вершин</span>' +
                            '<span class="input-group-btn"><button class="btn btn-default" type="button" onclick="networkGraph.clearLayeredNet(); networkGraph.saveNameLayout(); networkGraph.saveNameRandom();networkGraph.saveNumNodesAndGenerate(); ui.nav.click(3);" style="width: 100px;">Создать</button></span>' + //  data-toggle="tooltip" data-placement="right" title="Подсказка"
                        '</div>' +

                            '<div id="params"></div>' +

                           ' </div>' +
                            ' </div>' +
                            ' </div>' +
                            '</div>' +
                            '</div>' +

                    '<div class="panel panel-default control-main">' +
                    '<div class="panel-heading">Открыть файл модели сети:</div>' +
                    '<div class="panel-body">' +
                        '<div class="form-group">' +
                           ' <div class="col-sm-12">' +

                         '<input type="file" class="file" onchange="networkGraph.clearLayeredNet(); ui.fileChangeHandler(this);" />' +

                            '    </div>' +
                            ' </div>' +
                            ' </div>' +
                            '</div>' +
                             '</div>' +

                    '<div class="panel panel-default control-main">' +
                    '<div class="panel-heading">Представление:</div>' +
                    '<div class="panel-body">' +
                        '<div class="form-group">' +
                           ' <div class="col-sm-12">' +

                        '<div class="input-group">' +
                            '<select class="form-control" id="name_layout" name="name_layout" style="width: 200px;">' +
                                '<option value="FR">Fruchterman-Reingold</option>' +
                                '<option value="KK">Kamada-Kawai</option>' +
                                '<option value="ISOM">ISOM</option>' +
                                '<option value="LinLog">LinLog</option>' +
                           //     '<option value="Sugiyama">Sugiyama</option>' +
                           //     '<option value="CompoundFDP">CompoundFDP</option>' +
                           //     '<option value="BoundedFR">BoundedFR</option>' +
                                '<option value="Circular">Circular</option>' +
                           //     '<option value="EfficientSugiyama">EfficientSugiyama</option>' +
                                '<option value="SimpleRandom">SimpleRandom</option>' +
                           //     '<option value="Tree">Tree</option>' +
                            '</select>' +
                            '<span class="input-group-addon" id="basic-addon2" style="width: 100px;">Укладка</span>' +
                            '<span class="input-group-btn"><button class="btn btn-default" type="button" onclick="networkGraph.saveNameLayout(); networkGraph.makeReLay(0); ui.nav.click(3);" style="width: 100px;">Обновить</button></span>' +
                        '</div>' +

                        '<div class="checkbox"><label><input type="checkbox" id="layers1" onchange="networkGraph.toggleLayeredNet(); networkGraph.makeReLay(1); ui.nav.click(3);"' + checked + '>Послойная модель</label></div>' +

//                        '<br></br>' +
                        '<div class="checkbox"><label><input type="checkbox" id="wb3" onchange="networkGraph.toggleWBPrint(); networkGraph.DoWBPrint();"' + checked3 + '>Ч/Б режим для печати</label></div>' +
                                                    '    </div>' +
                            ' </div>' +
                            ' </div>' +
                            '</div>' +
                             '</div>'
                             ).show();

                            // Добавим/удалим выбор с укладки
                            $('#name_random').val(save_name_random).change();
                            $('#name_layout').val(save_name_layout).change();
                            break;

                        // Подпункт меню "Статистика и свёртка"
                        case 1:
                            //                            li_right_menu.eq(2).addClass('active');
                            //                            li_left_menu.eq(0).addClass('active');
                            networkGraph.netStatistic(); // Обновим статистику
                            break;

                        // Подпункт меню "Эпидемии" "Микрофрактал"
                        case 2:
//                            li_right_menu.eq(1).addClass('active');
//                            li_left_menu.eq(1).addClass('active');

                            // Выпадающие списки для тем
                            var html = '';
                            for (var i = 0; i < lines_microfractal; i++) {
                                html += '<option value="' + i + '">Тема' + (i + 1) + '</option>';
                            }

                            var checked = "";
                            if (networkGraph.isTwoModel == true) checked = "checked";

                            $('#info').html(
//                        '<br></br>' +
                        '<div class="input-group">' +
                            '<input type="text" class="form-control" placeholder="" aria-describedby="basic-addon2" value="' + coeff_reposts + '" name="input_coeff_reposts" style="width: 60px;">' +
                            '<span class="input-group-addon" id="basic-addon2" style="width: 50px;">Коэффициент репостов</span>' +
                        '</div>' +

                        '<li class="list-group-item" style="border:0px; width: 300px;">' +
                        'Одиночная/двойная модель' +
                        '<div class="material-switch pull-right">' +
                        '<input id="someSwitchOptionDefault" name="someSwitchOption001" onchange="networkGraph.toggleOneTwoModel(); networkGraph.changeGraph(); ui.nav.click(2);" type="checkbox"' + checked + '/>' +
                        '<label for="someSwitchOptionDefault" class="label-default"></label>' +
                        '</div>' +
                        '</li>' +

                        '<div id="two_contents"></div>'
                               ).show();

                            if (networkGraph.isTwoModel == true) $('#two_contents').html(
                        /// Два списка тем
                        '<div class="input-group">' +
                            '<select class="form-control" id="name_tem1" name="name_tem1" style="width: 200px;">' +
                                html +
                            '</select>' +
                            '<span class="input-group-addon" id="basic-addon2" style="width: 50px;">1</span>' +
                        '</div>' +

                        '<div class="input-group">' +
                            '<select class="form-control" id="name_tem2" name="name_tem2" style="width: 200px;">' +
                                html +
                            '</select>' +
                            '<span class="input-group-addon" id="basic-addon2" style="width: 50px;">2</span>' +
                        '</div>'
                                ).show();

                            // Добавим/удалим выбор с микрофракталов
                            $('#name_tem1').val(selected_tem1).change();
                            $('#name_tem2').val(selected_tem2).change();

                            // Data matrix
                            $('#data_matrix').html(ui.transition.build('1 2 3', '1 4 5')).show();
                            break;

                        // Пункт меню "Эпидемии"
                        case 3:
                            //                            li_left_menu.eq(0).addClass('active');

                            var checked = "";
                            if (networkGraph.isLayeredDisplay == true) checked = "checked";

                            $('.control-additional2').show();
                            $('#control-epidemic-my2').html(
                        '<div class="checkbox"><label><input type="checkbox" id="layers1" onchange="networkGraph.toggleLayeredNet(); networkGraph.makeReLay(1); ui.nav.click(3);"' + checked + '>Послойная модель</label></div>' +
                        '<button type="button" class="btn btn-default" onclick="networkGraph.toCenter();" style="width:25%; margin-left: 0px;"><span class="glyphicon glyphicon-resize-small"></span></button>'
                        ).show();

                            //                            li_left_menu.eq(1).addClass('active');
                            // $('.control-epidemic').show();
                            $('.control-additional1').show();
                            $('#control-epidemic-my1').html(
                        '<div class="progress" style="margin-bottom:5px;">' +
                        '<div id="epidemic_progress" class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:0%;"></div></div>' +

                        '<div class="input-group">' +
                            '<input type="text" class="form-control" placeholder="" aria-describedby="basic-addon2" value="' + save_num_steps + '" name="num_steps">' +
                            '<span class="input-group-addon" id="basic-addon2">Количество шагов</span>' +
                        '</div>' +

                            '<div class="btn-group" style="width:100%;">' +
                            '<button type="button" class="btn btn-default" onclick="networkGraph.saveNumSteps(); networkGraph.inRealTime();" style="width:25%; margin-left: 0px;"><span class="glyphicon glyphicon-play"></span></button>' +
                            '<button type="button" class="btn btn-default" onclick="networkGraph.pauseepidemi();" style="width:25%; margin-left: 0px;"><span class="glyphicon glyphicon-pause"></span></button>' +
                            '<button type="button" class="btn btn-default" onclick="networkGraph.stopepidemi();" style="width:25%; margin-left: 0px;"><span class="glyphicon glyphicon-stop"></span></button>' +
                            '<button type="button" class="btn btn-default" onclick="networkGraph.clearLayeredNet(); networkGraph.clearepidemi(); ui.nav.click(3);" style="width:25%; margin-left: 0px;"><span class="glyphicon glyphicon-refresh"></span></button>' +
                            '</div>' +
                         '<div class="form-group">' +
                            '<div class="col-sm-12">' +
                                '<label style="font-weight: 100;"><input type="range" min="100" max="2000" step="1" value="' + wait_time + '" name="wait_time" />Задержка</label>' +
                           '</div>' +
                        '</div>'
                            ).show();

                            $('#svg_container').show();

                            // Делаем лишние кнопки неактивными
                        /*    if (disabledMenuFlag) {
                                var li_right_menu2 = $('.control-nav li'); //control - nav
                                li_right_menu2.eq(1).addClass("disabled").find("a").attr("onclick", "return false;");
                                li_right_menu2.eq(3).addClass("disabled").find("a").attr("onclick", "return false;");
                            }*/


                            var html = '';

                            html += '<div class="row control-nav2" id="podmenu2">' +
                                    '<ul class="nav nav-tabs">';

                            if (!networkGraph.isTwoModel) {
                                for (var i = 0; i < lines_microfractal; i++) {
                                    if (i == selected_tematic)
                                        html += '<li class="active"><a href="#" onclick="networkGraph.setTematicChanged();  networkGraph.choseMicrofractal(' + i + '); networkGraph.changeGraph(); ui.nav.click(3);">Тема' + (i + 1) + '</a></li>';
                                    else html += '<li><a href="#" onclick="networkGraph.setTematicChanged(); networkGraph.choseMicrofractal(' + i + '); networkGraph.changeGraph(); ui.nav.click(3)">Тема' + (i + 1) + '</a></li>';
                                }
                            }
                            else html += '<li class="active"><a href="#" onclick="ui.nav.click(3);">Тема' + (parseInt(selected_tem1) + 1) + ',' + (parseInt(selected_tem2) + 1) + '</a></li>';

                            html += '</ul>' +
                                    '</div>';

                            $('#nav_epidemic_result').html(html).show();


                            // Делаем лишние кнопки неактивными
                          /*  if (disabledMenuFlag) {
                                var li_tematic_menu = $('.control-nav2 li'); //control - nav

                                for (var i = 0; i < lines_microfractal; i++) {
                                    if (i != selected_tematic)
                                        li_tematic_menu.eq(i).addClass("disabled").find("a").attr("onclick", "return false;");
                                }
                            }*/


                            if (networkGraph.isLayeredDisplay == true)
                            {
                                var checked2 = "";
                                if (networkGraph.isLayeredDisplayCut == true) checked2 = "checked";

                                $('#control-epidemic-my2').html(
                            '<div class="checkbox"><label><input type="checkbox" id="layers1" onchange="networkGraph.toggleLayeredNet(); networkGraph.makeReLay(1); ui.nav.click(3);"' + checked + '>Послойная модель</label></div>' +
                        '<div>' +
                        '<div class="checkbox"><label><input type="checkbox" id="layers2" onchange="networkGraph.toggleLayeredNetCut(); networkGraph.makeReLay(1); ui.nav.click(3);"' + checked2 + '>Исключить неиспользуемые слои</label></div>' +

                            '<div class="input-group" style="width:100%;">' +
                            '<input type="text" class="form-control" placeholder="" aria-describedby="basic-addon2" value="' + networkGraph.save_dx + '" name="grid_dx">' +
                            '<span class="input-group-addon" style="width:35%;" id="basic-addon2">dx</span>' +
                            '</div>' +

                            '<div class="input-group" style="width:100%;">' +
                            '<input type="text" class="form-control" placeholder="" aria-describedby="basic-addon2" value="' + networkGraph.save_dy + '" name="grid_dy">' +
                            '<span class="input-group-addon" style="width:35%;" id="basic-addon2">dy</span>' +
                            '</div>' +

                            '<div class="input-group" style="width:100%;">' +
                            '<input type="text" class="form-control" placeholder="" aria-describedby="basic-addon2" value="' + networkGraph.save_letter + '" name="letter">' +
                            '<span class="input-group-addon" style="width:35%;" id="basic-addon2">Шрифт</span>' +
                            '</div>' +

                            '<button type="button" class="btn btn-default" onclick="networkGraph.toCenter();" style="width:25%; margin-left: 0px;"><span class="glyphicon glyphicon-resize-small"></span></button>' +
                            '<button class="btn btn-default center-block" type="button" onclick="networkGraph.saveDLays(); networkGraph.makeReLay(1); ui.nav.click(3);">Обновить</button>' + //ui.nav.click(0);
                        '</div>'
                            ).show();
                            }
                            break;

                        // Подпункт меню "Графики"
                        case 4:
//                            li_right_menu.eq(2).addClass('active');
//                            li_left_menu.eq(1).addClass('active');

                            var checked = "";
                            if (networkGraph.isSetSum == false) checked = "checked";

                            if (networkGraph.isTwoModel == false) networkGraph.drawDiagram();
                            else networkGraph.drawDiagramTwo();

                            $('#svg_container3').show();

                            $('.control-additional2').show();
                            $('#control-epidemic-my2').html(
                             '<div>' +
                            '<li class="list-group-item" style="border:0px;">' +
                            'Сумма/прирост' +
                            '<div class="material-switch pull-right">' +
                            '<input id="someSwitchOptionDefault2" name="someSwitchOption002" type="checkbox" onchange="networkGraph.toggleSum(); ui.nav.click(4);"' + checked + '/>' +
                            '<label for="someSwitchOptionDefault2" class="label-default"></label>' +
                            '</div>' +
                            '</li>' +
                            '</div>' +
                            '<div>' +
                            '<button type="button" class="btn btn-default" onclick="networkGraph.toggleStretch(); ui.nav.click(4);" style="width:25%; margin-left: 0px;"><span class="glyphicon glyphicon-zoom-in"></span></button>' +
                            '</div>'
                  /*          '<li class="list-group-item" style="border:0px;">' +
                            'Лин/лог масштаб' +
                            '<div class="material-switch pull-right">' +
                            '<input id="someSwitchOptionDefault3" name="someSwitchOption003" type="checkbox" onchange="networkGraph.toggleLinLogScale(); ui.nav.click(4);"' + checked + '/>' +
                            '<label for="someSwitchOptionDefault3" class="label-default"></label>' +
                            '</div>' +
                            '</li>'*/
                        ).show();


                            var html = '';

                            html += '<div class="row control-nav2" id="podmenu2">' +
                                    '<ul class="nav nav-tabs">';

                            if ((!networkGraph.isTwoModel) && (!isRiskAndChance)) {
                                if ((selected_status == 0) && (!isOnlyTems)) html += '<li class="active"><a onclick="networkGraph.choseOneStatusGraphic(0); ui.nav.click(4);">Инфицированные</a></li>';
                                else html += '<li><a href="#" onclick="networkGraph.choseOneStatusGraphic(0); ui.nav.click(4);">Инфицированные</a></li>';

                                if ((selected_status == 1) && (!isOnlyTems)) html += '<li class="active"><a onclick="networkGraph.choseOneStatusGraphic(1); ui.nav.click(4);">Защищённые</a></li>';
                                else html += '<li><a href="#" onclick="networkGraph.choseOneStatusGraphic(1); ui.nav.click(4);">Защищённые</a></li>';

                                if ((selected_status == 2) && (!isOnlyTems)) html += '<li class="active"><a onclick="networkGraph.choseOneStatusGraphic(2); ui.nav.click(4);">Латентные</a></li>';
                                else html += '<li><a href="#" onclick="networkGraph.choseOneStatusGraphic(2); ui.nav.click(4);">Латентные</a></li>';

                                if ((selected_status == 3) && (!isOnlyTems)) html += '<li class="active"><a onclick="networkGraph.choseOneStatusGraphic(3); ui.nav.click(4);">Удалённые</a></li>';
                                else html += '<li><a href="#" onclick="networkGraph.choseOneStatusGraphic(3); ui.nav.click(4);">Удалённые</a></li>';

                                if ((selected_status == 4) && (!isOnlyTems)) html += '<li class="active"><a onclick="networkGraph.choseOneStatusGraphic(4); ui.nav.click(4);">Восприимчивые</a></li>';
                                else html += '<li><a href="#" onclick="networkGraph.choseOneStatusGraphic(4); ui.nav.click(4);">Восприимчивые</a></li>';

                            for (var i = 0; i < lines_microfractal; i++) {
                                if ((i == selected_tematic)&&(isOnlyTems))
                                    html += '<li class="active"><a href="#" onclick="networkGraph.choseMicrofractal(' + i + '); ui.nav.click(4);">Тема' + (i + 1) + '</a></li>';
                                else html += '<li><a href="#" onclick="networkGraph.choseMicrofractal(' + i + '); ui.nav.click(4)">Тема' + (i + 1) + '</a></li>';
                                }
                            }
                            else if ((!networkGraph.isTwoModel) && (selectedGraphicType == 2)) {
                                html += '<li><a href="#" onclick="ui.nav.click(4)">Риск</a></li>';
                            }
                            else if ((!networkGraph.isTwoModel) && (selectedGraphicType == 3)) {
                                html += '<li><a href="#" onclick="ui.nav.click(4)">Шанс</a></li>';
                            }
                            else html += '<li class="active"><a href="#" onclick="ui.nav.click(4);">Тема' + (parseInt(selected_tem1) + 1) + ',' + (parseInt(selected_tem2) + 1) + '</a></li>';

                            html += '</ul>' +
                                    '</div>';

                            $('#nav_epidemic_result').html(html).show();

                            // Делаем лишние кнопки неактивными
                       /*     if (disabledMenuFlag) {
                                var li_tematic_menu2 = $('.control-nav2 li'); //control - nav

                                for (var j = 0; j < lines_microfractal; j++) {
                                    if (j != selected_tematic)
                                    li_tematic_menu2.eq(j + 5).addClass("disabled").find("a").attr("onclick", "return false;");
                                }
                            }*/

                            ////////////////////"Таблицы"

                          //  if (networkGraph.isTwoModel == false) {
                                $('#data_export').html(
                                '<div class="col-sm-12" style="text-align:right; padding-right: 0;">' +
                                '<input type="button" class="btn btn-default" onclick="ui.downloadFile(\'xls\', $(\'#data_matrix table\').get(0)) " value="XLS" />' +
                                '<input type="button" class="btn btn-default" onclick="ui.downloadFile(\'txt\', $(\'#data_matrix table\').get(0))" value="TXT" />' +
                                '</div>'
                            ).show();

                                $('#data_matrix').html(ui.epidemic_build()).show();
                            //}
                            break;
/*
                            var li_right_menu3 = $('.control-nav li'); //control - nav
                            li_right_menu3.eq(riskAnalisChoice).addClass('active'); */
                    }
                }
                //включить вкладку
                , enable: function (index) {
                    var li = $('.control-nav li');
                    li.eq(index).removeClass('disabled');
                }
                //выключить вкладку
                , disable: function (index) {
                    var li = $('.control-nav li');
                    li.eq(index).addClass('disabled');
                }
            }

            //для матрицы микро-фрактала
            , transition: {
                row_delete: function (element) {
                    if (lines_microfractal == 1) return;

                    var num = $('#data_matrix thead td').index($(element).parents('td').eq(0));
                    $('#data_matrix tbody tr:eq(' + num + ')').remove(); //(num - 3)

                    // Сохраняем
                    var table = $("#data_matrix table").get(0);
                    microfractal_html_save = table.innerHTML;

                    // Сейчас строк:
                    var lines_now = $('#data_matrix tbody tr').size();
                    lines_microfractal = lines_now;
                }
                , row_add: function () {
                    var html;
                    //Выход если больше 5 строк
//                    if ($('#data_matrix thead td').size() == 14) { return }
                    if ($('#data_matrix tbody tr').size() == 5) { return }

                    // Сейчас строк:
                    var lines_now = $('#data_matrix tbody tr').size();
                    lines_microfractal = lines_now + 1;

                    //создаем строку после последней строки в секции tbody
                    for (var i = 0; i < 5; i++) {
                        if (i == 0) {
                            html += ('<td class="info">Тема' + (lines_now + 1) + '</td>');
                        } else {
                            html += ('<td><input type="text" class="form-control" value="' + masMicrofractalP[lines_microfractal - 1][i] + '" name="microfractal_' + lines_microfractal + '_' + i + '"/></td>');
                        }
                    }

                    $('#data_matrix tbody:last').append('<tr>' + html + '</tr>');

                    // Сохраняем
                    var table = $("#data_matrix table").get(0);
                    microfractal_html_save = table.innerHTML;
                }

                //строим разметку матрицы по умолчанию
                , build: function (filled_header, filled_matrix) {
                    //                    document.write(1777);

                    var html = '';

                    // Глиф-иконочки
                    html += ('<div style="text-align: right;">'); //btn - group
                    html += ('<label class="btn btn-default btn-file"><span class="glyphicon glyphicon-floppy-save"></span><input type="file" style="display: none;" onchange="ui.fileChangeHandler2(this);"></label>'); //btn - xs
                    html += ('<button type="button" class="btn btn-default" onclick="ui.downloadFile2()"><span class="glyphicon glyphicon-floppy-open"></span></button>'); //btn - xs
                    html += ('</div>');

                    html += '<table class="table table-bordered" >';
                    var header = ['pi', 'pr', 'pe', 'pm'];
                    var fixed_header_length = header.length;

                    //header draw
                    html += ('<thead>');

                        html += '<tr>'
                        html += ('<td class="info"></td>');
                        for (var i = 0; i < 4; i++) { //header.length;
                            if (i < 4) {
                                html += (['<td class="info">'
                                    , header[i]
                                    , '</td>'].join(''));
                            }
                        }
                        html += '</tr>'
                        html += ('</thead>');
                        //data draw
                        html += ('<tbody>');
                        for (var i = 0; i < lines_microfractal; i++) { //header.length - 1
                            html += '<tr>'
                            html += ('<td class="info"> Тема' + (i + 1) + '</td>'); //+ header[i + 2] +

                            for (var j = 0; j < header.length; j++) {
                                html += '<td><input type="text" class="form-control" value="' + masMicrofractalP[i][j] + '" name="microfractal_' + (i + 1) + '_' + (j + 1) + '"/></td>'
                            }

 //                           html += '<td></td>'
                            html += '</tr>'
                        }

                    html += ('</tbody>');
                    html += '</table>';

                    html += ('<div class="input-group">'); //btn - group
                    html += ('<button type="button" class="btn btn-default" onclick="ui.transition.row_add(); ui.nav.click(2);"><span class="glyphicon glyphicon-plus"></span></button>'); //btn - xs
                    html += ('<button type="button" class="btn btn-default" onclick="ui.transition.row_delete(this); ui.nav.click(2);"><span class="glyphicon glyphicon-remove"></span></button>'); //btn - xs
                    html += ('<input type="button" class="btn btn-default" onclick="microFractalGraph.saveCoeffReposts(); microFractalGraph.saveSelectedTems(); microFractalGraph.saveP(); ui.nav.click(3);" value="Сохранить" />');
                    html += ('</div>');

                    return html;
                }

            }
            //Событие изменения файла сети
            , fileChangeHandler: function fileChangeHandler(element) {
                var formData = new FormData();
                formData.append('file', element.files[0]);
                $.ajax({
                    url: '/Main/NetworkBuilder'
                    , type: 'POST'
                    , data: formData
                    , dataType: "json"
                    , processData: false
                    , contentType: false
                    //в случае успешного ответа от сервера, выполняем функцию
                    , success: function (data) {
                        if (data.success) {
                            //при успешных данных ответа, обновляем сеть
                            networkGraph.refreshNet(data);
                            ui.nav.click(3);
                        }
                        else {
                            //Вывести warning
                            ui.displayMessage([{ message: "Файл сети не является верным", type: "warning" }]);
                        }
                    }
                });
            }

            //Событие изменения файла микрофрактала
            , fileChangeHandler2: function fileChangeHandler2(element) {
                var formData = new FormData();
                formData.append('file', element.files[0]);

//                document.write(element.files[0]);

                $.ajax({
                    url: '/Main/FractalBuilder'
                    , type: 'POST'
                    , data: formData
                    , dataType: "json"
                    , processData: false
                    , contentType: false
                    //в случае успешного ответа от сервера, выполняем функцию
                    , success: function (data) {
                        if (data.success) {

//                            document.write(data["fractals"].length);

                            var new_lines_microfractal = data["fractals"].length;
                            //Добавляем/удаляем недостающие/лишние строки

                            var raznost = new_lines_microfractal - lines_microfractal;

                            if (raznost > 0) {
                                for (var i = 0; i < raznost; i++) { ui.transition.row_add(); }
                            }
                            else if (raznost < 0) {
                                for (var i = 0; i < (-raznost); i++) { ui.transition.row_delete(this); }
                            }

                            for (var i = 0; i < new_lines_microfractal; i++) {
                                masMicrofractalP[i][0] = data["fractals"][i]["pi"];
                                masMicrofractalP[i][1] = data["fractals"][i]["pr"];
                                masMicrofractalP[i][2] = data["fractals"][i]["pe"];
                                masMicrofractalP[i][3] = data["fractals"][i]["pm"];
                            }

                            lines_microfractal = new_lines_microfractal;

                            //при успешных данных ответа
                            ui.nav.click(2);
                        }
                        else {
                            //Вывести warning
                            ui.displayMessage([{ message: "Файл микрофрактала не является верным", type: "warning" }]);
                        }
                    }
                });
            }
            //создание дефолтной разметки для матрицы эпидемии(все есть во входном массиве: default)
            , epidemic_build: function () {
//                var fixed_header = ['N', 'Крит'];
                var html = '<table class="table table-bordered">';
                //header draw
                html += '<thead>'
                html += '<tr>'

                if ((isOnlyTems) && (networkGraph.isTwoModel == false)) {
                    if(!isRiskAndChance){
                        html += ('<td class="info">' + 'Шаг' + '</td>');
                        html += ('<td class="info">' + 'Инфицированные' + '</td>');
                        html += ('<td class="info">' + 'Защищённые' + '</td>');
                        html += ('<td class="info">' + 'Латентные' + '</td>');
                        html += ('<td class="info">' + 'Удалённые' + '</td>');
                        html += ('<td class="info">' + 'Восприимчивые' + '</td>');
                    } else {
                        html += ('<td class="info">' + 'Шаг' + '</td>');
                        html += ('<td class="info">' + 'Тема 1' + '</td>');
                        if (lines_microfractal > 1) html += ('<td class="info">' + 'Тема 2' + '</td>');
                        if (lines_microfractal > 2) html += ('<td class="info">' + 'Тема 3' + '</td>');
                        if (lines_microfractal > 3) html += ('<td class="info">' + 'Тема 4' + '</td>');
                        if (lines_microfractal > 4) html += ('<td class="info">' + 'Тема 5' + '</td>');
                    }
                } else if (networkGraph.isTwoModel) {
                    if (!isRiskAndChance) {
                        html += ('<td class="info">' + 'Шаг' + '</td>');
                        html += ('<td class="info">' + 'Инфицированные1' + '</td>');
                        html += ('<td class="info">' + 'Инфицированные2' + '</td>');
                        html += ('<td class="info">' + 'Защищённые1' + '</td>');
                        html += ('<td class="info">' + 'Защищённые2' + '</td>');
                        html += ('<td class="info">' + 'Латентные1' + '</td>');
                        html += ('<td class="info">' + 'Латентные2' + '</td>');
                        html += ('<td class="info">' + 'Удалённые' + '</td>');
                        html += ('<td class="info">' + 'Восприимчивые' + '</td>');
                    } else {
                        if (selectedGraphicType == 3){
                            html += ('<td class="info">' + 'Шаг' + '</td>');
                            html += ('<td class="info">' + 'Тема' + (parseInt(selected_tem1) + 1) + '</td>');
                            html += ('<td class="info">' + 'Тема' + (parseInt(selected_tem2) + 1) + '</td>');
                            html += ('<td class="info">' + 'Тема' + (parseInt(selected_tem1) + 1) + (parseInt(selected_tem2) + 1) + '</td>');
                            html += ('<td class="info">' + 'Тема' + (parseInt(selected_tem2) + 1) + (parseInt(selected_tem1) + 1) + '</td>');
                        } else {
                            html += ('<td class="info">' + 'Шаг' + '</td>');
                            html += ('<td class="info">' + 'Тема' + (parseInt(selected_tem2) + 1) + '</td>');
                            html += ('<td class="info">' + 'Тема' + (parseInt(selected_tem1) + 1) + '</td>');
                            html += ('<td class="info">' + 'Тема' + (parseInt(selected_tem2) + 1) + (parseInt(selected_tem1) + 1) + '</td>');
                            html += ('<td class="info">' + 'Тема' + (parseInt(selected_tem1) + 1) + (parseInt(selected_tem2) + 1) + '</td>');
                        }
                    }
                } else {
                    html += ('<td class="info">' + 'Шаг' + '</td>');
                    html += ('<td class="info">' + 'Тема1' + '</td>');
                    if (lines_microfractal > 1) html += ('<td class="info">' + 'Тема2' + '</td>');
                    if (lines_microfractal > 2) html += ('<td class="info">' + 'Тема3' + '</td>');
                    if (lines_microfractal > 3) html += ('<td class="info">' + 'Тема4' + '</td>');
                    if (lines_microfractal > 4) html += ('<td class="info">' + 'Тема5' + '</td>');
                }

                html += '</tr>'
                html += '</thead>'
                //data draw
                html += '<tbody>'

                // Составляем общий Temp массив
                if (networkGraph.isTwoModel == false) {
                    var mas_length = TemsObjects[selected_tematic].Nodes.Infected.length;
                    var masTemp = networkGraph.getTempMas();

                    for (var i = 0; i < mas_length; i++) {
                        html += '<tr>'
                        html += ('<td class="info">' + i + '</td>');
                        html += ('<td>' + masTemp[0][i] + '</td>');
                        if ((lines_microfractal > 1) || (isOnlyTems && !isRiskAndChance)) html += ('<td>' + masTemp[1][i] + '</td>');
                        if ((lines_microfractal > 2) || (isOnlyTems && !isRiskAndChance)) html += ('<td>' + masTemp[2][i] + '</td>');
                        if ((lines_microfractal > 3) || (isOnlyTems && !isRiskAndChance)) html += ('<td>' + masTemp[3][i] + '</td>');
                        if ((lines_microfractal > 4) || (isOnlyTems && !isRiskAndChance)) html += ('<td>' + masTemp[4][i] + '</td>');
                        html += '</tr>'
                    }
                } else {
                    var mas_length = TemsObjectsTwo[0].Nodes.Infected1.length;
                    var masTempTwo = networkGraph.getTempMasTwo();

                    if (!isRiskAndChance) {
                        for (var i = 0; i < mas_length; i++) {
                            html += '<tr>'
                            html += ('<td class="info">' + i + '</td>');
                            html += ('<td>' + masTempTwo[0][i] + '</td>');
                            html += ('<td>' + masTempTwo[1][i] + '</td>');
                            html += ('<td>' + masTempTwo[2][i] + '</td>');
                            html += ('<td>' + masTempTwo[3][i] + '</td>');
                            html += ('<td>' + masTempTwo[4][i] + '</td>');
                            html += ('<td>' + masTempTwo[5][i] + '</td>');
                            html += ('<td>' + masTempTwo[6][i] + '</td>');
                            html += ('<td>' + masTempTwo[7][i] + '</td>');
                            html += '</tr>'
                        }
                    } else {
                        for (var i = 0; i < mas_length; i++) {
                            html += '<tr>'
                            html += ('<td class="info">' + i + '</td>');
                            html += ('<td>' + masTempTwo[0][i] + '</td>');
                            html += ('<td>' + masTempTwo[1][i] + '</td>');
                            html += ('<td>' + masTempTwo[2][i] + '</td>');
                            html += ('<td>' + masTempTwo[3][i] + '</td>');
                            html += '</tr>'
                        }
                    }
                }

                html += '</tbody>'
                html += '</table>';
                return html;
            }
            //Отображение сообщения bootstrap
            , displayMessage: function (messages) {
                for (var i = 0; i < messages.length; i++) {
                    $('#info').append([
                     '<div class="alert alert-' + messages[i].type + '">'
                    , '<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>'
                    , messages[i].message
                    , '</div>'
                    ].join('')
                )
                }
            }
            //все для отрисовки графиков
            , drawFunction: function (element, data, titles) {
                // define dimensions of graph
                var m = [80, 80, 80, 80]; // margins
                var w = 900 - m[1] - m[3]; // width
                var h = 400 - m[0] - m[2]; // height

                // create a simple data array that we'll plot with a line (this array represents only the Y values, X will just be the index location)

                // X scale will fit all values from data[] within pixels 0-w
                var x = d3.scale.linear().domain([0, data.length - 1]).range([0, w]);
                // Y scale will fit values from 0-10 within pixels h-0 (Note the inverted domain for the y-scale: bigger is up!)
                //var y = d3.scale.linear().domain([0, data.sort().reverse()[0]]).range([h, 0]);
                // automatically determining max range can work something like this
                var y = d3.scale.linear().domain([0, d3.max(data)]).range([h, 0]);

                // create a line function that can convert data[] into x and y points
                var line = d3.svg.line().interpolate("basis")
                    // assign the X function to plot our line as we wish
                    .x(function (d, i) {
                        // verbose logging to show what's actually being done
                        //                    console.log('Plotting X value for data point: ' + d + ' using index: ' + i + ' to be at: ' + x(i) + ' using our xScale.');
                        // return the X coordinate where we want to plot this datapoint
                        return x(i);
                        //return i;
                    })
                    .y(function (d) {
                        // verbose logging to show what's actually being done
                        //                  console.log('Plotting Y value for data point: ' + d + ' to be at: ' + y(d) + " using our yScale.");
                        // return the Y coordinate where we want to plot this datapoint
                        return y(d);
                    })

                // Add an SVG element with the desired dimensions and margin.
                var graph = d3.select(element).append("svg:svg")
                      .attr("width", w + m[1] + m[3])
                      .attr("height", h + m[0] + m[2])
                    .append("svg:g")
                      .attr("transform", "translate(" + m[3] + "," + m[0] + ")");

                // create yAxis
                //var xAxis = d3.svg.axis().scale(x).tickSize(-h).tickSubdivide(false);
                var xAxis = d3.svg.axis().scale(x).tickSize(-h).tickValues(new Array(data.length - 1).fill(0).map(function (elem, index) { return index + 1; }))
                // Add the x-axis.
                graph.append("svg:g")
                      .attr("class", "x axis")
                      .attr("transform", "translate(0," + h + ")")
                      .call(xAxis);


                // create left yAxis
                var yAxisLeft = d3.svg.axis().scale(y).ticks(4).orient("left");
                // Add the y-axis to the left
                graph.append("svg:g")
                      .attr("class", "y axis")
                      .attr("transform", "translate(-25,0)")
                      .call(yAxisLeft);

                // Add the line by appending an svg:path element with the data line we created above
                // do this AFTER the axes above so that the line is above the tick-lines
                graph.append("svg:path").attr("d", line(data));

                graph.append("text")
                    .attr("x", 0)
                    .attr("y", -13)
                    .attr("text-anchor", "end")
                    .style("font-size", "13px")
                    .text(titles.y);

                graph.append("text")
                    .attr("x", w + m[1] - 13)
                    .attr("y", h + 3)
                    .attr("text-anchor", "end")
                    .style("font-size", "13px")
                    .text(titles.x);
            }

            , downloadFile: function (type, table) {
                //var table = $("#data_matrix table").get(0);
                var name_file;

                if (ui.nav.current_index == 1)
                    name_file = 'Матрица взвешенности';
                else if (ui.nav.current_index == 2)
                    name_file = 'Матрица связности';
                else if (ui.nav.current_index == 3)
                    name_file = 'Матрица центральности';
                else if (ui.nav.current_index == 5)
                    name_file = 'Матрица эпидемии';

                name_file = 'Этапы эпидемии';

                if (type == "xls") {
                    name_matrix = name_file;

                    var uri = 'data:application/vnd.ms-excel;base64,'
                        , template = ['<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">'
                                    , '<head>'
                                    , '<!--[if gte mso 9]>'
                                    , '<xml>'
                                    , '<x:ExcelWorkbook>'
                                    , '<x:ExcelWorksheets>'
                                    , '<x:ExcelWorksheet>'
                                    , '<x:Name>'
                                    , '{worksheet}'
                                    , '</x:Name>'
                                    , '<x:WorksheetOptions>'
                                    , '<x:DisplayGridlines/>'
                                    , '</x:WorksheetOptions>'
                                    , '</x:ExcelWorksheet>'
                                    , '</x:ExcelWorksheets>'
                                    , '</x:ExcelWorkbook>'
                                    , '</xml>'
                                    , '<![endif]-->'
                                    , '<meta http-equiv="content-type" content="text/plain; charset=UTF-8"/>'
                                    , '</head>'
                                    , '<body>'
                                    , '<table>'
                                    , '{table}'
                                    , '</table>'
                                    , '</body>'
                                    , '</html>'].join('')
                        , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
                        , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }

                    var link = document.createElement('a');
                    link.download = name_file + '.' + type;
                    link.href = uri + base64(format(template, { worksheet: name_matrix, table: table.innerHTML }));
                    link.click();
//                    document.write(table.innerHTML);

                } else if (type == "txt") {

                    var dataToDownload = '';

                    if ((isOnlyTems) && (networkGraph.isTwoModel == false)) {
                        dataToDownload += 'Шаг Инфицированные Защищённые Латентные Удалённые Восприимчивые \r\n';
                    } else if (networkGraph.isTwoModel) {
                        if (!isRiskAndChance) {
                            dataToDownload += 'Шаг Инфицированные1 Инфицированные2 Защищённые1 Защищённые2 Латентные1 Латентные2 Удалённые Восприимчивые \r\n';
                        } else {
                            if (selectedGraphicType == 3) dataToDownload += 'Шаг Тема' + (parseInt(selected_tem1) + 1) +' Тема ' + (parseInt(selected_tem2) + 1) + ' Тема ' + (parseInt(selected_tem1) + 1) + (parseInt(selected_tem2) + 1) + ' Тема ' + (parseInt(selected_tem2) + 1) + (parseInt(selected_tem1) + 1) + ' \r\n';
                            else dataToDownload += dataToDownload += 'Шаг Тема' + (parseInt(selected_tem2) + 1) + ' Тема ' + (parseInt(selected_tem1) + 1) + ' Тема ' + (parseInt(selected_tem2) + 1) + (parseInt(selected_tem1) + 1) + ' Тема ' + (parseInt(selected_tem1) + 1) + (parseInt(selected_tem2) + 1) + ' \r\n';
                        }
                    } else {
                        dataToDownload += 'Шаг Тема1 Тема2 Тема3 Тема4 Тема5 \r\n';
                    }

                    // Составляем общий Temp массив
                    if (networkGraph.isTwoModel == false) {
                        var mas_length = TemsObjects[selected_tematic].Nodes.Infected.length;
                        var masTemp = networkGraph.getTempMas();

                        for (var i = 0; i < mas_length; i++) {
                            dataToDownload += i + ' ' + masTemp[0][i];
                            if ((lines_microfractal > 1) || (isOnlyTems && !isRiskAndChance)) dataToDownload += ' ' + masTemp[1][i];
                            if ((lines_microfractal > 2) || (isOnlyTems && !isRiskAndChance)) dataToDownload += ' ' + masTemp[2][i];
                            if ((lines_microfractal > 3) || (isOnlyTems && !isRiskAndChance)) dataToDownload += ' ' + masTemp[3][i];
                            if ((lines_microfractal > 4) || (isOnlyTems && !isRiskAndChance)) dataToDownload += ' ' + masTemp[4][i];
                            dataToDownload += '\r\n';
                        }
                    }
                    else {
                        var mas_length = TemsObjectsTwo[0].Nodes.Infected1.length;
                        var masTempTwo = networkGraph.getTempMasTwo();

                        if (!isRiskAndChance) {
                            for (var i = 0; i < mas_length; i++) {
                                dataToDownload += i + ' ' + masTempTwo[0][i] + ' ' + masTempTwo[1][i] + ' ' + masTempTwo[2][i] + ' ' + masTempTwo[3][i] + ' ' + masTempTwo[4][i] + ' ' + masTempTwo[5][i] + ' ' + masTempTwo[6][i] + ' ' + masTempTwo[7][i] + '\r\n';
                            }
                        } else {
                            for (var i = 0; i < mas_length; i++) {
                                dataToDownload += i + ' ' + masTempTwo[0][i] + ' ' + masTempTwo[1][i] + ' ' + masTempTwo[2][i] + ' ' + masTempTwo[3][i] + '\r\n';
                            }
                        }
                    }

                    var link = document.createElement('a');
                    link.download = name_file + '.' + type;
                    link.href = 'data:Application/octet-stream,' + encodeURIComponent(dataToDownload);
                    link.click();

                    //document.location = 'data:Application/octet-stream,' + encodeURIComponent(dataToDownload);
                }
            }

            , downloadFile2: function () {
                var name_file = 'микрофрактал';

                    var dataToDownload = '';

                    dataToDownload += 'pi pr pe pm\r\n';

                    for (var i = 0; i < lines_microfractal; i++) {
                        dataToDownload += masMicrofractalP[i][0] + ' ' + masMicrofractalP[i][1] + ' ' + masMicrofractalP[i][2] + ' ' + masMicrofractalP[i][3] + '\r\n';
                    }

                    var link = document.createElement('a');
                    link.download = name_file + '.txt';
                    link.href = 'data:Application/octet-stream,' + encodeURIComponent(dataToDownload);
                    link.click();
            }

            , changeMatrix: function (elements) {
                $("#data_matrix td").removeClass("centrality");

                var tr = $("#data_matrix tr");
                for (var i = 0; i < elements.length; i++) {
                    $('td', tr.eq(elements[i] + 1)).eq(elements[i] + 1).addClass("centrality");
                }

                return;
                var table = $("#data_matrix table").get(0);

                for (var i = 0; i < table.rows.length; i++) {
                    table.rows.item(i).cells.item(i).style.backgroundColor = 'white';
                }

                for (var i = 0; i < elements.length; i++) {
                    table.rows.item(elements[i] + 1).cells.item(elements[i] + 1).style.backgroundColor = 'red';
                }
            }
        }
            </script>
            <script type="text/javascript">
                //При загрузке документа всегды выполняется:
                $(document).ready(function () { networkGraph.generateNet(); ui.nav.click(3); });
            </script>

            <div class="row text-right">
                <hr>
                <footer>
                    <p>©2017 – приложение кафедры СИБ</p>
                </footer>
            </div>
        </div>

        <script type="text/javascript">
            /*function screenSize() {
                var w, h; // Объявляем переменные, w - длина, h - высота
                w = (window.innerWidth ? window.innerWidth : (document.documentElement.clientWidth ? document.documentElement.clientWidth : document.body.offsetWidth));
                h = (window.innerHeight ? window.innerHeight : (document.documentElement.clientHeight ? document.documentElement.clientHeight : document.body.offsetHeight));
                return { w: w, h: h };
            }
            alert(screenSize().w);*/
            var startX;
            var flagMD = false;
            var offset;
            var elementPos;
            var direction = true;

            function resizeSidebar() {
                //alert("we have been there");
                if (direction) {
                    document.getElementById('sidebar').style.right = parseInt(document.getElementById('sidebar').style.right.replace("px", "")) - 2 + "px";
                }
                else {
                    document.getElementById('sidebar').style.right = parseInt(document.getElementById('sidebar').style.right.replace("px", "")) + 2 + "px";
                }
            }

            graph.ontouchstart = function (event) {
                var winWidth = (window.innerWidth ? window.innerWidth : (document.documentElement.clientWidth ? document.documentElement.clientWidth : document.body.offsetWidth));
                startX = event.touches[0].clientX;
                flagMD = true;
                elementPos = (document.body.scrollWidth - document.getElementById('sidebar').clientWidth) / document.body.scrollWidth * 100;
                document.getElementById('sidebar').style.right = elementPos + '%';
            };
            graph.ontouchmove = function (event) {
                if (flagMD) {
                    if ((-event.touches[0].clientX + startX) > 0) {
                        if (parseInt(document.getElementById('sidebar').style.right.replace("%", "")) < 100) {
                            var i = Math.round((-event.touches[0].clientX + startX) / 10);
                            document.getElementById('sidebar').style.right = elementPos + Math.round((-event.touches[0].clientX + startX) / 10) + '%';
                        }
                    }
                    else {
                        if (parseInt(document.getElementById('sidebar').style.right.replace("%", "")) > 3) {
                            var i = Math.round((-event.touches[0].clientX + startX) / 10);
                            document.getElementById('sidebar').style.right = elementPos + Math.round((-event.touches[0].clientX + startX) / 10) + '%';
                        }
                    }

                }
            };

            graph.ontouchend = function (event) {
                //alert(document.body.clientWidth + " " + document.body.clientHeight);
                var winWidth = (window.innerWidth ? window.innerWidth : (document.documentElement.clientWidth ? document.documentElement.clientWidth : document.body.offsetWidth));
                flagMD = false;
                if (startX > event.changedTouches[0].clientX) {
                    direction = false;
                }
                else {
                    direction = true;
                }
                var limit;
                if (direction) {
                    limit = (document.body.clientWidth - document.getElementById('sidebar').clientWidth - 10) / 2;
                }
                else {
                    limit = document.getElementById('sidebar').clientWidth / 2;
                }
                
                document.getElementById('sidebar').style.right = document.body.scrollWidth - document.getElementById('sidebar').clientWidth + 'px';
                for (i = 0; i < limit; i++) {
                    setTimeout(resizeSidebar, i);
                }
            };

            /*sidebar.onmousedown = function () {
                startX = event.clientX;
                flagMD = true;
                elementPos = parseInt(document.getElementById('sidebar').style.right.replace("%", ""));
                var v = parseInt(document.getElementById('sidebar').style.right.replace("%", ""));
                v = v;
            };
            sidebar.onmousemove = function () {
                if (flagMD) {
                    if ((-event.clientX + startX) > 0) {
                        if (parseInt(document.getElementById('sidebar').style.right.replace("%", "")) < 100) {
                            document.getElementById('sidebar').style.right = elementPos - event.clientX + startX + '%';
                        }
                    }
                    else {
                        if (parseInt(document.getElementById('sidebar').style.right.replace("%", "")) > 3) {
                            document.getElementById('sidebar').style.right = elementPos - event.clientX + startX + '%';
                        }
                    }

                }
            };

            sidebar.onmouseup = function (event) {
                flagMD = false;
            };*/
            //$(document).oneTime(100, function () { resizeSidebar(true); });
            //$(document).oneTime(100, function () { resizeSidebar(true); });

        </script>


        <!-- Visual Studio Browser Link -->
        <script type="application/json" id="__browserLink_initializationData">
            {"appName":"Chrome","requestId":"82564dbe5eec4fa0af03a9fa0f61a1ad"}
        </script>
        <script type="text/javascript" src="./CountMetrics – приложение ASP.NET_files/browserLink" async="async"></script>
        <!-- End Browser Link -->



</body></html>